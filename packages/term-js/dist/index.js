import{template as e,omit as t,isUndefined as i,last as s,isString as n,unescape as r,identity as a,noop as o,isArray as l,get as h,isNumber as d,isObject as c}from"lodash-es";import u from"resize-observer-polyfill";import{Emitter as p}from"key-layers-js";import{v1 as g}from"uuid";const m=e=>e?e.which||e.keyCode:null,f=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),v=e=>{let{size:t}=v;if(t)return t;const i=e||document.body,s=document.createElement("div"),n=document.createElement("div");return s.style.width="100px",s.style.height="100px",s.style.overflow="scroll",n.style.height="100px",i.appendChild(s),s.appendChild(n),t=s.offsetWidth-n.offsetWidth,i.removeChild(s),v.size=t,t};class b{constructor(){b.activateRequestAnimationFrame(),this.registerFrameHandler()}static activateRequestAnimationFrame(){b.animationFrame||(b.animationFrame=window.requestAnimationFrame(b.requestAnimationFrameHandler))}static deactivateRequestAnimationFrame(){b.handlerList.length||window.cancelAnimationFrame(b.animationFrame)}static requestAnimationFrameHandler(){b.handlerList.forEach((e=>e())),b.animationFrame=window.requestAnimationFrame(b.requestAnimationFrameHandler)}destroy(){this.removeHandler()}registerFrameHandler(){this.frameHandler&&this.addHandler()}unregisterFrameHandler(){this.frameHandler&&this.removeHandler()}addHandler(){const{frameHandler:e}=this;e&&(b.activateRequestAnimationFrame(),b.handlerList.push(e))}removeHandler(){const{handlerList:e}=b,{frameHandler:t}=this;if(t&&e.includes(t)){const i=e.indexOf(t);e.splice(i,1)}b.deactivateRequestAnimationFrame()}}b.handlerList=[];const y=/class="[^"]+"/gi,L=/ref="[^"]+"/gi,C=/<If\scondition="\{[^"]+}">/gi,S=/<\/If>/gi,H=/<Choose>/gi,w=/<\/Choose>/gi,T=/<Choose>(.(?!\/Choose>)|\n(?!\/Choose>)|\s(?!\/Choose>))+/gi,F=/<When\scondition="\{[^"]+}">(.(?!\/When>)|\n(?!\/When>)|\s(?!\/When>))+/gi,E=/<When\scondition="\{[^"]+}">/gi,R=/<\/When>/gi,I=/<Otherwise>(.(?!\/Otherwise>)|\n(?!\/Otherwise>)|\s(?!\/Otherwise>))+/gi,k=/<Otherwise>/gi,x=/<\/Otherwise>/gi;class V extends b{constructor(e,t){super(),this.childNodesField=[],this.templateField="",this.isHidden=!1,this.refMap={},e&&(this.template=e),this.containerField=t||this.containerField}static getProxyChildNodes(e){const t=document.createElement("div"),i=[];t.innerHTML=e;const{childNodes:s}=t;for(let e=0,t=s.length;e<t;e+=1)i.push(s[e]);return i}static insertAfter(e,t,i){const{childNodes:s}=e,n=Array.prototype.indexOf.call(s,i);n<0||(n===s.length-1?e.appendChild(t):e.insertBefore(t,s[n+1]))}static getRenderStringWithClassNames(e,t={}){const{css:i}=t;if(!i)return e;const s=e.match(y);return s?s.reduce(((e,t)=>{const s=t.replace('class="',"").replace('"',"").split(" "),n=s.map((e=>i[e]||e)).join(" "),r=new RegExp(`class="${s.join("\\s")}"`);return e.replace(r,`class="${n}"`)}),e):e}static getRenderStringWithVariables(e,t={}){return delete t.css,Object.keys(t).reduce(((e,i)=>{const s=new RegExp(`\\{${i}}`,"g");return e.replace(s,t[i])}),e)}static getTemplateExecutor(t){let i=V.getTemplateExecutorStringWithLodashConditions(t);return i=V.getTemplateExecutorStringWithLodashSwitches(i).replace(/\s*%>[\s\n]*<%\s*/g," "),e(i)}static getTemplateExecutorStringWithLodashConditions(e){const t=e.match(C);return t?t.reduce(((e,t)=>{const i=t.replace(/^<If\scondition="\{/i,"").replace(/}">$/,"");return e.replace(t,`<% if (${i}) { %>`)}),e).replace(S,"<% } %>"):e}static getTemplateExecutorStringWithLodashSwitches(e){if(!H.test(e))return e;return(e.match(T)||[]).reduce(((e,t)=>this.getTemplateExecutorStringWithLodashWhen(e,t.replace(/<Choose>[^<]*/i,""))),e).replace(H,"").replace(w,"")}static getTemplateExecutorStringWithLodashWhen(e,t){const i=t.match(F)||[],s=t.match(I)||[],n=i.reduce(((e,t,i)=>{const s=t.match(E);if(!s)return e;const n=s[0],r=n.replace(/^<When\scondition="\{/i,"").replace(/}">$/,""),a=t.replace(n,`<%${i?" else":""} if (${r}) { %>`);return e.replace(t,a)}),e).replace(R,"<% } %>");return 1===s.length?s.reduce(((e,t)=>{const s=t.replace(k,i.length?"<% else {  %>":"");return e.replace(t,s)}),n).replace(x,i.length?"<% } %>":""):n}get childNodes(){return this.childNodesField}set childNodes(e){this.childNodesField=e}get nodeList(){return this.childNodes||[]}get template(){return this.templateField}set template(e){this.templateExecutor=V.getTemplateExecutor(e),this.templateField=e}get container(){return this.containerField}set container(e){this.containerField=e}destroy(){super.destroy();const{container:e,childNodes:t}=this;null==t||t.forEach((t=>{null==e||e.removeChild(t)}))}show(e=!0,t){if(!this.isHidden)return;this.isHidden=!1;const{container:i,childNodes:s}=this;i&&s&&(t?this.addChildNodesWithRef(e,t):this.addChildNodesWithoutRef(e))}hide(){if(this.isHidden)return;this.isHidden=!0;const{container:e,childNodes:t}=this;e&&t&&t.forEach((t=>{this.checkChildExists(t)&&e.removeChild(t)}))}getRefMap(){return Object.assign({},this.refMap)}getRef(e){return this.refMap[e]}render(e,t){const{container:i,template:s}=this;i&&s&&(this.insertRenderString(this.getRenderString(e),t||{}),this.saveRefs())}getRenderString(e){const{templateExecutor:i}=this;if(!i)return"";let s=i(t(e,["css"]));return s=V.getRenderStringWithClassNames(s,e),V.getRenderStringWithVariables(s,e)}saveRefs(){const{container:e}=this,t=this.template.match(L);this.refMap=t?t.reduce(((t,i)=>{const s=i.replace(/^ref="/,"").replace(/"$/,"");if(!s)return t;const n=null==e?void 0:e.querySelector(`[ref="${s}"]`);return n?(n.removeAttribute("ref"),t[s]=n,t):t}),{}):{}}insertRenderString(e,t){const{replace:i,append:s=!0,ref:n}=t;return i?this.replaceRenderString(e,i):n?this.addRenderStringWithRef(s,e,n):this.addRenderStringWithoutRef(s,e)}replaceRenderString(e,t){const i=this.container,{childNodes:s}=i,n=V.getProxyChildNodes(e),r=t.nodeList;r&&r.length===n.length&&(n.forEach(((e,t)=>{const n=r[t];n&&Array.prototype.includes.call(s,n)&&i.replaceChild(e,n)})),this.childNodes=n)}addRenderStringWithoutRef(e,t){this.childNodes=V.getProxyChildNodes(t),this.addChildNodesWithoutRef(e)}addChildNodesWithoutRef(e){const t=this.container,i=this.childNodes,s=t.firstChild;i.forEach((t=>{e?this.appendChild(t):this.insertBefore(t,s)})),this.childNodes=i}addRenderStringWithRef(e,t,i){this.childNodes=V.getProxyChildNodes(t),this.addChildNodesWithRef(e,i)}addChildNodesWithRef(e,t){const i=this.childNodes,s=t.nodeList;if(!(null==s?void 0:s.length))return;const n=e?s[s.length-1]:s[0];(e?Array.prototype.reverse.call(i):i).forEach(((t,s)=>e?s?this.insertBefore(t,i[0]):this.insertAfter(t,n):this.insertBefore(t,n)))}checkChildExists(e){const{container:t}=this;if(t){const i=t.childNodes;return Array.prototype.includes.call(i,e)}return!1}insertBefore(e,t){const{container:i}=this;i&&this.checkChildExists(t)&&i.insertBefore(e,t)}insertAfter(e,t){const{container:i}=this;i&&this.checkChildExists(t)&&V.insertAfter(i,e,t)}appendChild(e){const{container:t}=this;t&&t.appendChild(e)}}class N extends V{constructor(e,t){super('<div ref="root" class="VirtualizedList__root className">\n  <div ref="virtualizedList" class="VirtualizedList">\n    <div ref="itemsContainer" class="VirtualizedList__itemsContainer"></div>\n  </div>\n  <div ref="generalList" class="VirtualizedList__generalList"></div>\n</div>\n',e),this.lengthValue=0,this.height=0,this.itemsCache={},this.viewportItems=[],this.renderedItems=[],this.offset=0,this.restoreParams={index:-1,bottomOffset:-1,width:-1,height:-1},this.renderViewportItems=()=>{const{length:e,heightGetter:t,topOffset:s,bottomOffset:n}=this,r=this.getRef("root");if(!r)return;this.restoreScrollTop();const a=Math.max(r.scrollTop-s,0),o=a+r.getBoundingClientRect().height+s,l=o+n;let h,d=0,c=0,u=!1,p=!1,g=0,m=0,f=-1,v=!0;const b=[];for(let s=0;s<e;s+=1){const e=t(s);d=c,c=d+e;const n=N.checkViewportItem({viewportStart:a,viewportEnd:l,itemOffsetStart:d,itemOffsetEnd:c}),r=v?N.checkFullViewportItem({viewportStart:a,itemOffsetStart:d,itemOffsetEnd:c,viewportEnd:o}):v;if(u=n||u,p=r||p,p&&!r&&(v=!1),v&&(g+=m,m=e,f=s),u&&!n)break;n&&(b.push(s),h=i(h)?d:h)}this.viewportItems=b,this.offset=h||0,this.updateRestoreParams(f,g,m),this.renderItems()},window.vl=this,this.lengthValue=t.length,this.itemGetter=t.itemGetter,this.heightGetter=t.heightGetter,this.topOffset=t.topOffset||this.topOffset,this.bottomOffset=t.bottomOffset||this.bottomOffset,this.render({css:Object.assign(Object.assign({},undefined),{className:t.className||""})}),this.renderViewportItems(),this.frameHandler=this.renderViewportItems,this.registerFrameHandler()}set length(e){this.lengthValue=e,this.updateHeight(),this.renderViewportItems()}get length(){return this.lengthValue}static checkFullViewportItem(e){const{viewportStart:t,viewportEnd:i,itemOffsetStart:s,itemOffsetEnd:n}=e;return t<=s&&i>=n}static checkViewportItem(e){const{viewportStart:t,viewportEnd:i,itemOffsetStart:s,itemOffsetEnd:n}=e;return t<=s&&i>=n||t>s&&t<n||i>s&&i<n}scrollBottom(){i(this.scrollTimeout)||clearTimeout(this.scrollTimeout);const e=this.getRef("root");e&&(this.scrollTimeout=setTimeout((()=>{e.scrollTop=e.scrollHeight-e.offsetHeight}),0))}destroy(){i(this.scrollTimeout)||clearTimeout(this.scrollTimeout),super.destroy()}getGeneralItemsContainer(){return this.getRef("generalList")}getVirtualItemsContainer(){return this.getRef("itemsContainer")}render(e){super.render(e),this.updateHeight()}updateViewport(){this.removeAllItems(),this.updateHeight(),this.renderItems()}clearCache(){this.itemsCache={}}updateHeight(){const{length:e,heightGetter:t}=this,i=this.getRef("virtualizedList");let s=0;for(let i=0;i<e;i+=1)s+=t(i);this.height!==s&&(i.style.height=`${s}px`),this.height=s}renderItems(){const{viewportItems:e,offset:t,renderedItems:i}=this,s=this.getRef("itemsContainer");s&&(e.length!==i.length||i.some(((t,i)=>t!==e[i])))&&(e.length||this.removeAllItems(),this.removeStartItems(),this.removeEndItems(),e.forEach((e=>{this.renderItem(e)})),s.style.top=`${Math.round(t)}px`)}renderItem(e){const{itemsCache:t,renderedItems:s,itemGetter:n}=this;let r=-1;const a=s.find(((t,i)=>t>e&&(r=i,!0))),o=this.getRef("itemsContainer");if(o)if(i(a)){if(t[e])return t[e].show(),void(s.includes(e)||s.push(e));const i=n(e,{container:o});i&&(t[e]=i),s.includes(e)||s.push(e)}else{const i=t[a],l=t[e];if(!i)return;if(l)return l.show(!1,i),void(s.includes(e)||s.splice(r,0,e));const h=n(e,{container:o,append:!1,ref:i});h&&(t[e]=h),s.includes(e)||s.splice(r,0,e)}}removeStartItems(){const{viewportItems:e,renderedItems:t}=this;if(e.length){const i=e[0];let s=0;t.some((e=>e>=i||(s+=1,this.removeItem(e),!1))),t.splice(0,s)}}removeEndItems(){const{viewportItems:e,renderedItems:t}=this;if(e.length){let i=0;const n=s(e);t.reverse().some((e=>e<=n||(i+=1,this.removeItem(e),!1))),t.splice(0,i),t.reverse()}}removeAllItems(){const{renderedItems:e}=this;e.forEach((e=>this.removeItem(e))),this.renderedItems=[]}removeItem(e){const{itemsCache:t}=this;t[e]&&t[e].hide()}restoreScrollTop(){const{index:e,height:t,width:i}=this.restoreParams;e>=0&&t>=0&&i>=0&&this.updateScrollTop()}updateScrollTop(){const{length:e,heightGetter:t}=this,{width:i,index:s,bottomOffset:n}=this.restoreParams,r=this.getRef("root");if(!r||i===r.offsetWidth)return;const{offsetHeight:a}=r;let o=0,l=0;for(let i=0;i<e;i+=1){if(i===s){l=t(i);break}o+=t(i)}r.scrollTop=Math.max(0,o+l+n-a)}updateRestoreParams(e,t,i){const s=this.getRef("root");if(!s)return;const{offsetHeight:n,offsetWidth:r,scrollTop:a}=s;this.restoreParams={index:e,width:r,height:n,bottomOffset:a+n-t-i}}}const _=(()=>{const e=new Map;return(t,i=!1)=>{const s=t||document.body,n=(t=>{const i=e.get(t);if(i)return i;const s=document.createElement("span");return s.innerHTML="&nbsp;",s.style.position="absolute",s.style.left="0",s.style.top="0",s.style.visibility="hidden",s.style.pointerEvents="none",s.style.userSelect="none",t.appendChild(s),s})(s),r=n.getBoundingClientRect();return t&&i?(e.has(s)||e.set(s,n),r):(e.delete(s),s.removeChild(n),r)}})();class O extends V{constructor(){super(...arguments),this.value="",this.prevLock=!1,this.lockField=!1,this.prevBusy=!1,this.busyField=!1,this.prevHidden=!1,this.hiddenField=!1,this.left=0,this.prevLeft=0,this.top=0,this.prevTop=0}get lock(){return this.lockField}set lock(e){this.lockField=e,this.updateStyles()}get busy(){return this.busyField}set busy(e){this.busyField=e,this.updateStyles()}get hidden(){return this.hiddenField}set hidden(e){this.hiddenField=e,this.updateStyles()}setPosition(e,t){this.left=e,this.top=t,this.updateStyles()}updateStyles(){const{lock:e,busy:t,hidden:i,left:s,prevLeft:n,top:r,prevTop:a}=this,o=this.getRef("root");o&&(s!==n&&(o.style.left=`${s}px`),r!==a&&(o.style.top=`${r}px`),this.updateLockStyles(),this.updateBusyStyles(),this.updateHiddenStyles(),this.prevLeft=s,this.prevTop=r,this.prevLock=e,this.prevBusy=t,this.prevHidden=i)}}class P{constructor(){}static registerCaret(e,t){P.caretMap[e]=t}static getInstance(){return P.instance||(P.instance=new P),P.instance}create(e,t){return P.caretMap[e]?new P.caretMap[e](t):null}}P.caretMap={simple:class extends O{constructor(e){super('<span ref="root" class="SimpleCaret">\n  <span ref="character" class="SimpleCaret__character"></span>\n</span>\n',e),this.render()}updateLockStyles(){const e=this.getRef("root"),{lock:t,prevLock:i}=this;e&&t!==i&&(t?e.classList.add("SimpleCaret--lock"):e.classList.remove("SimpleCaret--lock"))}updateBusyStyles(){const e=this.getRef("root"),{busy:t,prevBusy:i}=this;e&&t!==i&&(t?e.classList.add("SimpleCaret--busy"):e.classList.remove("SimpleCaret--busy"))}updateHiddenStyles(){const e=this.getRef("root"),{hidden:t,prevHidden:i}=this;e&&t!==i&&(t?e.classList.add("SimpleCaret--hidden"):e.classList.remove("SimpleCaret--hidden"))}setValue(e){const t=this.getRef("character");t&&this.value!==e&&(this.value=e,t.innerHTML=e)}}};const M=e=>e.replace(/<span[^>]*>/g,"").replace(/<\/span>/g,"");class z extends V{constructor(e,t,i){super(e,t),this.characterWidth=8,this.characterHeight=16,this.valueField="",this.isCaretHidden=!1,this.secretField=!1,this.mouseDownHandler=e=>{const t=this.getEventFormattedValueFragment(e);t&&t.clickHandler&&t.lock&&e.preventDefault()},this.clickHandler=e=>{const t=this.getEventFormattedValueFragment(e);t&&t.clickHandler&&t.clickHandler(e,t.id)},this.render({css:i}),this.setCharacterContainer(),this.addHandlers()}static getValueString(e,t={}){const{secret:i=!1}=t;return n(e)?i?z.convertSecret(e):e:e.reduce(((e,t)=>{const s=n(t)?t:t.str;return`${e}${!i||!n(t)&&t.lock?s:z.convertSecret(s)}`}),"")}static getFragmentTemplate(e,t){const{className:i="",secret:s=!1,index:n}=t;return`<span\n      data-index="${n}"\n      ref="fragment-${n}"\n      class="${[s?"BaseInput__secret":"",i].join(" ")}">${z.getNormalizedTemplateString(s?z.convertSecret(e):e)}</span>`}static getNormalizedTemplateString(e){return f(e).replace(/\s/g,"&nbsp;")}static getValueFragmentTemplate(e,t,i={}){const{secret:s}=i;if(n(e))return z.getFragmentTemplate(e,{index:t,secret:s});const{str:r,className:a="",lock:o}=e,l=!o&&s;return z.getFragmentTemplate(r,{className:a,index:t,secret:l})}static getValueTemplate(e,t={}){return n(e)?z.getNormalizedTemplateString(e):e.reduce(((e,i,s)=>`${e}${z.getValueFragmentTemplate(i,s,t)}`),"")}static getUpdatedValueField(e,t){if(n(t))return e;let i=M(e),s=!1;const r=t.reduce(((e,t)=>{const r=n(t),a=r?t:t.str,{str:o,isFull:l}=((e,t)=>{if(0===t.indexOf(e))return{str:e,isFull:!0};if(e[0]!==t[0])return{str:"",isFull:!1};let i=e[0];for(let s=1,n=e.length;s<n;s+=1){const n=e[s];if(n!==t[s])break;i+=n}return{str:i,isFull:!1}})(a,i);return o&&!s&&(e.push(r?o:Object.assign(Object.assign({},t),{str:o})),i=i.substring(o.length),s=!l),e}),[]);return i.replace(/<span[^>]*>/g,"").split("").forEach((e=>r.push(e))),r.filter((e=>n(e)?e:e.str))}static getLockString(e){if(n(e))return"";let t="",i="";return e.forEach((e=>{n(e)?t+=e:(t+=e.str,e.lock&&(i=t))})),i}static convertSecret(e){return new Array(e.length).fill("•").join("")}get characterSize(){const{characterContainer:e}=this;return e?e.getBoundingClientRect():{width:this.characterWidth,height:this.characterHeight}}get caretPosition(){return-1}get selectedRange(){return{from:0,to:0}}get disabled(){return!0}get value(){return this.valueField}set value(e){this.valueField=e}get lockString(){const{valueField:e}=this;return z.getLockString(e)}get hiddenCaret(){return this.isCaretHidden}set hiddenCaret(e){this.isCaretHidden=e}get secret(){return this.secretField}set secret(e){this.secretField=e}get isFocused(){const{activeElement:e}=document,t=this.getRef("input");return e===t||(null==e?void 0:e.parentNode)===t||(null==e?void 0:e.parentNode)===t}addHandlers(){const e=this.getRootElement();e&&(e.addEventListener("click",this.clickHandler),e.addEventListener("mousedown",this.mouseDownHandler))}removeHandlers(){const e=this.getRootElement();e&&(e.removeEventListener("click",this.clickHandler),e.removeEventListener("mousedown",this.mouseDownHandler))}getValueItemString(e){const{valueField:t}=this;if(n(t))return e?"":t;const i=t[e];return i?n(i)?i:i.str:""}getSimpleValue(e=!0){const{secretField:t}=this;return z.getValueString(this.valueField,{secret:t&&!e})}moveCaretToEnd(e=!1){}addEventListener(e,t,i){const s=this.getRef("input");s&&s.addEventListener(e,t,i)}removeEventListener(e,t,i){const s=this.getRef("input");s&&s.removeEventListener(e,t,i)}focus(){const e=this.getRef("input");e&&e.focus()}blur(){const e=this.getRef("input");e&&e.blur()}destroy(){this.removeHandlers(),super.destroy()}getCaretOffset(){const{caretPosition:e,characterSize:t}=this,i=this.getRowCharactersCount();if(!i)return{left:0,top:0};const s=Math.floor(e/i);return{left:(e-s*i)*t.width,top:s*t.height}}getEndOffset(){const{characterSize:e,valueField:t}=this,i=this.getRowCharactersCount();if(!i)return{left:0,top:0};const s=z.getValueString(t).length,n=Math.floor(s/i);return{left:(s-n*i)*e.width,top:n*e.height}}getRowCharactersCount(){const{characterSize:e}=this,t=this.getRef("input");return t?Math.floor(t.offsetWidth/e.width):0}getEventFormattedValueFragment(e){const t=e.target;return t?this.getElementFormattedValueFragment(t):null}getElementFormattedValueFragment(e){const{valueField:t}=this;if(n(t))return null;const i=e.getAttribute("data-index"),s=i?t[Number(i)]:null;return!s||n(s)?null:s}setCharacterContainer(){const e=this.getRef("root");if(e){const t=document.createElement("span");t.style.position="absolute",t.style.visibility="hidden",t.style.pointerEvents="none",t.style.left="0",t.style.top="0",t.innerHTML="&nbsp;",e.appendChild(t),this.characterContainer=t}}}const W=/&nbsp;/g;class A extends z{constructor(e){super('<div ref="root" class="ContentEditableInput">\n  <div ref="input" class="ContentEditableInput__input" contenteditable="true"></div>\n  <div ref="hidden" class="ContentEditableInput__hidden"></div>\n</div>\n',e),this.externalChangeListeners=[],this.isDisabled=!1,this.pasteHandler=()=>{this.prevContent=z.getValueString(this.value)},this.changeHandler=e=>{this.updateValueField(),this.externalChangeListeners.forEach((t=>t.call(e.target,e)))},this.addEventListener("input",this.changeHandler),this.addEventListener("cut",this.changeHandler),this.addEventListener("paste",this.pasteHandler)}static getStyledValueTemplate(e,t={}){return z.getValueTemplate(e,t)}static getLastTextNode(e){const{lastChild:t}=e;return t?3===t.nodeType?t:A.getLastTextNode(t):null}static checkChildNode(e,t){if(e===t)return!0;const{parentNode:i}=t;return!!i&&A.checkChildNode(e,i)}static getHtmlStringifyValue(e){return e.replace(W," ")}static getNodeOffset(e,t,i=0){const{parentNode:s}=t;if(!s||e===t)return 0;let n=!1;const r=Array.prototype.filter.call(s.childNodes,(e=>{const i=e===t;return i&&!n&&(n=!0),!i&&!n})).reduce(((e,t)=>{const i=3===t.nodeType?t.nodeValue:A.getHtmlStringifyValue(t.innerHTML);return e+(i?i.length:0)}),0);return e===s?i+r:A.getNodeOffset(e,s,i+r)}set hiddenCaret(e){if(this.isCaretHidden===e)return;const t=this.getRef("input");e?t.classList.add("ContentEditableInput__input--hiddenCaret"):t.classList.remove("ContentEditableInput__input--hiddenCaret"),this.isCaretHidden=e}set value(e){this.valueField=e,this.updateContent()}get value(){return this.valueField}set secret(e){this.secretField=e,this.updateContent()}get caretPosition(){const e=this.getRef("input"),t=window.getSelection();if(!t||!t.isCollapsed||!t.anchorNode)return-1;const{anchorNode:i}=t;return A.checkChildNode(e,t.anchorNode)?A.getNodeOffset(e,i,3===i.nodeType?t.anchorOffset:0):-1}set caretPosition(e){if(e<0)return;const t=this.getRef("input");let i=0,s=0;const n=Array.prototype.find.call(t.childNodes,(t=>{const{length:n}=(3===t.nodeType?t.nodeValue:A.getHtmlStringifyValue(t.innerHTML))||"";return s=i,i+=n,e<=i})),r=window.getSelection();if(!r||!n)return;const a=new Range,o=3===n.nodeType?n:n.firstChild;a.setStart(o,e-s),a.setEnd(o,e-s),r.removeAllRanges(),r.addRange(a)}get disabled(){return this.isDisabled}set disabled(e){var t;this.isDisabled=e,null===(t=this.getRef("input"))||void 0===t||t.setAttribute("contenteditable",e?"false":"true")}moveCaretToEnd(e=!1){const t=this.getRef("input");if(e&&this.focus(),!t||!this.isFocused)return;const i=document.createRange(),s=window.getSelection(),n=A.getLastTextNode(t);n&&(i.selectNodeContents(n),i.collapse(!1),s&&(s.removeAllRanges(),s.addRange(i)))}addEventListener(e,t,i){"change"===e?this.externalChangeListeners.push(t):super.addEventListener(e,t,i)}removeEventListener(e,t,i){"change"===e?this.externalChangeListeners=this.externalChangeListeners.filter((e=>e!==t)):super.removeEventListener(e,t,i)}destroy(){super.destroy(),this.removeEventListener("input",this.changeHandler),this.removeEventListener("cut",this.changeHandler),this.removeEventListener("paste",this.pasteHandler)}getRootElement(){return this.getRef("input")}getPasteNormalizedData(){const{prevContent:e}=this,t=this.getRef("input"),s=r(t.innerHTML.replace(/<br>/g,"")).replace(W," ").replace(/<b>/g,"").replace(/<\/b>/g,"");if(i(e))return s;this.prevContent=void 0;const n=e.split("").reduce(((e,t,i)=>e>=0?e:s[i]!==t?i:e),-1),a=n>=0?e.substring(0,n):e,o=n>=0&&a.length!==e.length?e.substring(n):"",l=s.replace(a,"").replace(o,""),h=l.replace(/<[a-z]+[^>]*>/g,"").replace(/<[a-z]+[^>]*\/>/g,"").replace(/<\/[a-z]+>/g,"");return s.replace(l,h)}getInputValue(){return this.getPasteNormalizedData().replace(/<\/span>[^<]*</g,"</span><").split("</span>").filter(a).reduce(((e,t)=>{var i;const s=((null===(i=t.match(/data-index="[0-9]+"/))||void 0===i?void 0:i[0])||"").replace(/[^0-9]/g,"");if(s){const i=this.getValueItemString(Number(s));return`${e}${A.getHtmlStringifyValue(t).replace(new RegExp("•+"),i)}`}return`${e}${A.getHtmlStringifyValue(t)}`}),"")}updateValueField(){if(this.preventLockUpdate())return;const{caretPosition:e,isDisabled:t}=this;let i=e;if(t)i=Math.min(e,z.getValueString(this.valueField).length);else{const e=this.getInputValue();this.valueField=z.getUpdatedValueField(e,this.valueField)}this.updateContent(),this.caretPosition=i}preventLockUpdate(){const{valueField:e}=this;if(n(e))return!1;const t=M(this.getInputValue()),i=z.getLockString(e),s=i&&0===i.indexOf(t)&&i.length>t.length;if(s){const e=this.valueField.reduce(((e,t,i)=>!n(t)&&t.lock?i:e),-1);this.valueField=this.valueField.filter(((t,i)=>i<=e))}return!!(i&&0!==t.indexOf(i)||s)&&(this.updateContent(),this.moveCaretToEnd(),!0)}updateContent(){this.setString(),this.updateStyles()}setString(){const{secretField:e}=this,t=this.getRef("input"),i=this.getRef("hidden");if(t&&i){const s=A.getStyledValueTemplate(this.valueField,{secret:e});t.innerHTML=s,i.innerHTML=s}}updateStyles(){const e=this.getRef("input"),t=this.getRef("hidden");e&&t&&Array.prototype.forEach.call(t.childNodes,((t,i)=>{if(3!==t.nodeType){const{color:s}=window.getComputedStyle(t);s&&(e.childNodes[i].style.textShadow=`0 0 0 ${s}`)}}))}}class K extends z{set value(e){this.valueField=e;const t=this.getRef("input");t&&(t.innerHTML=z.getValueTemplate(this.valueField))}constructor(e){super('<div ref="root">\n  <div ref="input" class="ViewableInput">{value}</div>\n</div>\n',e)}render(){super.render({value:z.getValueTemplate(this.valueField)})}getRootElement(){return this.getRef("input")}}class D extends V{constructor(e,t={}){super('<If condition="{label || delimiter}">\n  <div class="Label__label">\n    <If condition="{label}">\n      <div class="Label__labelTextContainer">\n        <span class="Label__labelText" ref="label">{label}</span>\n      </div>\n      <div>\n        <span class="Label__labelText">{nbs}</span>\n      </div>\n    </If>\n    <If condition="{delimiter}">\n      <div class="Label__labelTextContainer">\n        <span class="Label__labelText" ref="delimiter">{delimiter}</span>\n      </div>\n      <div>\n        <span class="Label__labelText">{nbs}</span>\n      </div>\n    </If>\n  </div>\n</If>\n\n',e),this.label="",this.delimiter="",this.reRender=!1,this.label=t.label||"",this.delimiter=t.delimiter||"",this.render()}set params(e){this.label=e.label||this.label,this.delimiter=e.delimiter||this.delimiter,this.render()}get params(){const{label:e,delimiter:t}=this;return{label:e,delimiter:t}}render(){const{label:e,delimiter:t}=this;super.render({css:undefined,label:e,delimiter:t,nbs:"&nbsp;"},this.reRender?{replace:this}:{}),this.reRender=!0}}class $ extends V{constructor(e,t={}){super('<div ref="root" class="Line__root Line__visible {className}">\n  <div ref="content" class="Line__content">\n    <div ref="helpContainer" class="Label__labelText Line__helpContainer">{nbs}</div>\n    <div ref="labelContainer"></div>\n    <div ref="inputContainer" class="Line__inputContainer"></div>\n  </div>\n</div>\n',e),this.isVisible=!0,this.heightField=0,this.secretField=!1,this.initialValue="",this.className="",this.editable=!1,this.onSubmit=o,this.onChange=o,this.onUpdateCaretPosition=o,this.caretPosition=-1,this.updateHeight=()=>{const e=this.getRef("root");e&&(this.heightField=e.offsetHeight)},this.keyDownHandler=e=>{({13:this.submitHandler,37:this.lockCaret,39:this.lockCaret,38:this.lockCaret,40:this.lockCaret}[Number(m(e))]||o)(e)},this.submitHandler=e=>{const{onSubmit:t,inputField:i,secret:s}=this,r=(null==i?void 0:i.value)||"";let a="";n(r)?a=s?"":r:l(r)&&(a=s?r.filter((e=>h(e,"lock"))):r),null==e||e.preventDefault(),i&&t&&t({formattedValue:a,value:i.getSimpleValue(),lockString:i.lockString})},this.changeHandler=()=>{const{inputField:e}=this;e&&(this.updateInputSize(),this.lockCaret(),this.onChange(e.getSimpleValue()))},this.updateInputSize=()=>{const{width:e}=this.characterSize,t=this.getRef("inputContainer"),i=this.getRef("input"),{width:s}=t.getBoundingClientRect();if(!i)return this.updateRowsCount(2);const n=this.editable?i.value:i.innerHTML;if(!e||!n||!s)return this.updateRowsCount(2);const r=Math.floor(s/e);return this.updateRowsCount(Math.ceil(n.length/r)+1)},this.updateCaretData=()=>{const{editable:e,disabled:t,caret:i,inputField:s,onUpdateCaretPosition:n,caretPosition:r}=this;if(!e||!s||!i)return void(-1!==r&&(this.caretPosition=-1,n(this.caretPosition,this.caret)));const{caretPosition:a}=s;s.isFocused&&a>=0&&!t?this.showCaret(a):this.hideCaret(),r!==a&&(this.caretPosition=a,n(this.caretPosition,this.caret))},this.lockCaret=()=>{const{caret:e,lockTimeout:t}=this;t&&clearTimeout(t),e&&(e.lock=!0,this.lockTimeout=setTimeout((()=>e.lock=!1),600))},this.setParams(t),this.container=e,this.render({label:t.label,delimiter:t.delimiter}),this.setCaret(t.caret||"simple"),this.addEventListeners(),this.updateHeight(),this.frameHandler=this.updateCaretData,this.setupEditing()}static getHeight(e){const{delimiter:t,label:i,value:s,width:n,itemSize:r}=e,{width:a,height:o}=r,l=z.getValueString(s),h=(t?t.length+1:0)+(i?i.length+1:0),d=Math.floor((n-$.itemHorizontalPadding-h*a)/a);return Math.ceil((l.length||1)/d)*o+2*$.itemVerticalPadding}get value(){const{inputField:e}=this;return e?e.value:""}set value(e){const{inputField:t}=this;t&&(t.value=e,t.moveCaretToEnd())}get disabled(){const{input:e,editable:t}=this;return!t||!e||e.disabled}set disabled(e){const{input:t,caret:i,editable:s}=this;t&&s&&(t.disabled=e,i&&(i.hidden=e))}get focused(){const{inputField:e}=this;return!!e&&e.isFocused}get visible(){return this.isVisible}set visible(e){const t=this.getRef("root");this.isVisible!==e&&t&&(this.isVisible=e,e?t.classList.add("Line__visible"):t.classList.remove("Line__visible"))}get hidden(){return this.isHidden}get height(){return this.heightField}get characterSize(){return this.getRef("helpContainer").getBoundingClientRect()}get input(){return this.inputField}get secret(){return this.secretField}set secret(e){const{inputField:t}=this;this.secretField=e,t&&(t.secret=e)}get caretOffset(){const{input:e}=this;return this.getInputRootOffset(e?e.getCaretOffset():{left:0,top:0})}get endOffset(){const{input:e}=this;return this.getInputRootOffset(e?e.getEndOffset():{left:0,top:0})}get labelWidth(){var e,t;const{label:i,characterSize:{width:s}}=this;return i?(((null===(e=i.params.label)||void 0===e?void 0:e.length)||-1)+((null===(t=i.params.delimiter)||void 0===t?void 0:t.length)||-1)+2)*s:0}get contentPadding(){const e=this.getRef("content");if(!e)return{left:0,top:0};const t=window.getComputedStyle(e);return{left:Number(t.paddingLeft.replace("px","")),top:Number(t.paddingTop.replace("px",""))}}stopEdit(){const{label:e}=this,t=e?e.params:{label:"",delimiter:""};this.removeCaret(),this.removeEventListeners(),this.editable=!1,this.unregisterFrameHandler(),this.render(t)}focus(){const{inputField:e}=this;if(!e)return;const{isFocused:t}=e;t||(e.focus(),e.moveCaretToEnd())}blur(){const{inputField:e}=this;if(!e)return;const{isFocused:t}=e;t&&e.blur()}submit(){this.submitHandler()}render(e){const{editable:t,className:i,secret:s}=this,n=Boolean(this.getRef("root"));this.inputField&&(this.initialValue=this.inputField.value,this.inputField.destroy()),this.label&&this.label.destroy(),super.render({editable:t,className:i,nbs:"&nbsp;"},n?{replace:this}:{}),this.inputField=t?new A(this.getRef("inputContainer")):new K(this.getRef("inputContainer")),this.label=new D(this.getRef("labelContainer"),e),this.inputField.value=this.initialValue,this.inputField.secret=s}setCaret(e="simple"){const{inputField:t,editable:i}=this;this.removeCaret();const s=$.cf.create(e,this.getRef("inputContainer"));t&&(s&&i?(t.hiddenCaret=!0,this.caret=s,this.updateCaretData()):t.hiddenCaret=!1)}updateViewport(){const{isHidden:e}=this;e&&this.show(),this.updateInputSize(),e&&this.hide()}destroy(){super.destroy();const{lockTimeout:e}=this;e&&clearTimeout(e),this.removeCaret(),this.removeEventListeners()}moveCaretToEnd(e=!1){const{inputField:t,editable:i}=this;t&&i&&t.moveCaretToEnd(e)}clear(){this.value=""}setParams(e){const{onUpdateCaretPosition:t=o,onChange:i=o,onSubmit:s=o,editable:n=!0,className:r="",value:a,secret:l=!1}=e;this.className=r,this.onSubmit=s,this.onChange=i,this.onUpdateCaretPosition=t,this.editable=n,this.secret=l,this.initialValue=a||""}addEventListeners(){const{editable:e,inputField:t}=this;e&&t&&(t.addEventListener("keydown",this.keyDownHandler),t.addEventListener("change",this.changeHandler))}removeEventListeners(){const{editable:e,inputField:t}=this;e&&t&&(t.removeEventListener("keydown",this.keyDownHandler),t.removeEventListener("change",this.changeHandler))}setupEditing(){this.editable&&this.inputField&&(this.registerFrameHandler(),this.inputField.moveCaretToEnd(!0))}updateRowsCount(e){const t=this.getRef("input");this.editable&&t&&Number(t.getAttribute("rows"))!==e&&t.setAttribute("rows",String(e)),this.updateHeight()}showCaret(e){const{caret:t,inputField:i}=this,{width:s,height:n}=this.characterSize,r=this.getRef("inputContainer");if(!t||!r||!i)return;const{width:a}=r.getBoundingClientRect(),o=i.getSimpleValue(!1),l=Math.floor(a/s),h=Math.floor(e/l);t.hidden=!1;const d=" "===o[e]?"&nbsp;":o[e]||"&nbsp;",c=Math.round(n*h),u=Math.round((e-h*l)*s);t.setPosition(u,c),t.setValue(d)}hideCaret(){const{caret:e}=this;e&&(e.hidden=!0)}removeCaret(){const{caret:e}=this;e&&(this.caret=void 0,e.destroy())}getInputRootOffset(e){const{label:t,input:i,labelWidth:s,contentPadding:{top:n,left:r}}=this;return i||t?i?{left:e.left+s+r,top:e.top+n}:{left:s+r,top:n}:{left:r,top:n}}}$.cf=P.getInstance(),$.itemVerticalPadding=4,$.itemHorizontalPadding=16;class B{constructor(e,t){this.layerField=1,this.shortcutsMapField={},this.listeners={},this.isLock=!1,this.lockWhiteList=[],this.actionHandler=(e||{}).onAction,this.unlockKey=t||g()}static checkShortcutsEqual(e,t){const i=B.getNormalizedShortcut(e),s=B.getNormalizedShortcut(t);return i.ctrlKey===s.ctrlKey&&i.metaKey===s.metaKey&&i.altKey===s.altKey&&i.shiftKey===s.shiftKey&&((e,t)=>e.length===t.length&&e.every((e=>t.includes(e))))(i.codes,s.codes)}static getNormalizedShortcut(e){const t={codes:[],ctrlKey:!1,metaKey:!1,altKey:!1,shiftKey:!1};return d(e)?t.codes=[e]:l(e)&&d(e[0])?t.codes=e:(t.codes=l(e.code)?e.code:[e.code],t.ctrlKey=e.ctrl||t.ctrlKey,t.metaKey=e.meta||t.metaKey,t.altKey=e.alt||t.altKey,t.shiftKey=e.shift||t.shiftKey),t}get layer(){return this.layerField}set layer(e){const{layerField:t,emitter:i}=this;t!==e&&(this.layerField=e,i&&i.updateLayerType(e))}addListener(e,t,i){const{listeners:s}=this;s[e]||(s[e]=[]),s[e].push({callback:t,info:i})}removeListener(e){const{listeners:t}=this;Object.keys(t).some((i=>{const s=t[i].findIndex((t=>t.callback===e));return s>=0&&(t[i].splice(s,1),!0)}))}addShortcut(e,t,i){const{shortcutsMapField:s}=this;this.getShortcutIndex(e,t)>=0||(s[e]||(s[e]=[]),s[e].push({info:i,actionShortcut:t}),this.deactivate(),this.activate())}removeShortcut(e,t){const{shortcutsMapField:i}=this;if(!t)return delete i[e];const s=this.getShortcutIndex(e,t);return!0===s?delete i[e]:(s>=0&&(i[e].splice(s,1),this.deactivate(),this.activate()),null)}activate(){this.emitter||(this.emitter=new p(this.layerField),this.addListeners())}deactivate(){const{emitter:e}=this;e&&e.destroy(),delete this.emitter}destroy(){this.deactivate()}lock(e=[]){if(!this.isLock)return this.isLock=!0,this.lockWhiteList=e,()=>{this.unlock(this.unlockKey)}}unlock(e){this.unlockKey===e&&(this.isLock=!1,this.lockWhiteList=[])}getShortcutIndex(e,t){const i=this.shortcutsMapField[e];return i?i.findIndex((e=>B.checkShortcutsEqual(e.actionShortcut,t))):-1}addListeners(){const{emitter:e,shortcutsMapField:t,listeners:i,actionHandler:s,isLock:n,lockWhiteList:r}=this;e&&Object.keys(t).forEach((a=>{t[a].forEach((t=>{const{info:o}=t,l=B.getNormalizedShortcut(t.actionShortcut);e.addListener("keyDown",(e=>{if(n&&!r.includes(a))return;const t=i[a];t&&t.some((({callback:t,info:i})=>t(a,e,{listener:i,shortcut:o}))),s&&s(a,e)}),l)}))}))}}class j{constructor(e,t){this.value=e,this.typedValue=t}}const q=["change","focus","blur","keydown","keypress","keyup"];class G{constructor(e){this.action=e.action,this.data=e.data,this.target=e.target}}class U{constructor(e,t){this.pluginList=[],this.termInfo=e,this.keyboardShortcutsManager=t}updateTermInfo(e){this.termInfo=e,this.pluginList.forEach((({inst:t})=>{t.updateTermInfo(e)}))}register(e,t){const{pluginList:i,termInfo:s}=this,n=t||e.name;this.getPluginIndex(n,e)>=0||(i.push({name:n,inst:e}),this.clearPlugins(),e.setTermInfo(s,this.keyboardShortcutsManager))}unregister(e){const{pluginList:t}=this,i="string"==typeof e?this.getPluginIndex(e):this.getPluginIndex(e.name,e);if(i<0)return;t.splice(i,1);const s=t[i];s&&(this.clearPlugins(),s.inst.destroy())}destroy(){this.pluginList.forEach((({inst:e})=>e.destroy())),this.pluginList=[]}getPlugin(e){var t,i;const{pluginList:s}=this;return n(e)?(null===(t=s.find((({name:t})=>t===e)))||void 0===t?void 0:t.inst)||null:(null===(i=s.find((({inst:t})=>t instanceof e)))||void 0===i?void 0:i.inst)||null}getPluginIndex(e,t){const{pluginList:i}=this,s=i.findIndex((t=>t.name===e));return s>=0||!t?s:i.findIndex((e=>e.inst.equal(t)))}clearPlugins(){this.pluginList.forEach((({inst:e})=>e.clear()))}}class J{constructor(e,t){this.position=e,this.caret=t}}const Q=navigator.platform.toUpperCase().indexOf("MAC")>=0;class X{constructor(e){this.name="base",this.pluginManager=e}setTermInfo(e,t){this.termInfo=e,this.keyboardShortcutsManager=t}updateTermInfo(e){this.termInfo=e}destroy(){this.clear()}equal(e){return e.name===this.name}}class Y extends V{constructor(e,t={lines:[],editLine:""}){super('<div ref="root" class="Term">\n  <div ref="header" class="Term__header {hidden}">\n    <div ref="headerTextContainer" class="Term__headerTextContainer">\n      <span ref="headerText" class="Term__headerText">{header}</span>\n    </div>\n  </div>\n  <div ref="content" class="Term__content">\n    <div ref="linesContainer" class="Term__linesContainer"></div>\n  </div>\n</div>\n',e),this.isDisabled=!1,this.headerField="",this.history={list:[],index:-1,stopHistory:!1},this.params={label:"",delimiter:"~",header:"",caret:"",scrollbarSize:20,size:{width:1,height:1}},this.isEditing=!1,this.itemSize={width:1,height:1},this.heightCache=[],this.lines=[],this.skipHandler=!1,this.listeners={},this.addEventListener=(e,t,i)=>{const{listeners:s}=this;s[e]||(s[e]=[]),s[e].push({handler:t,options:i}),this.registerListener(e,t,i)},this.removeEventListener=(e,t,i)=>{const s=this.listeners[e];if(!s)return;const n=s.findIndex((e=>e.handler===t));n>=0&&s.splice(n,1),this.unregisterListener(e,t,i)},this.setLabel=(e={})=>{const{editLine:t,params:s}=this,{label:n,delimiter:r}=e;let a=!1;i(n)||(s.label=n,a=!0),i(r)||(s.delimiter=r,a=!0),t&&t.label&&(t.label.params=e),a&&this.updateTermInfo()},this.write=(e,t={})=>{const{editLine:i,isEditing:s}=this,{withSubmit:r,duration:a=0,skipHandler:o=!0}=t;if(o&&(this.skipHandler=!0),!i||s)return!!a&&Promise.resolve(!1);if(this.isEditing=!0,i.disabled=!0,a>=0){const{value:t}=i,s=n(e)?e:e.str,o=s.length/a;let l=0;const h=n(e)?{str:e}:Object.assign(Object.assign({},e),{str:""});return new Promise((n=>{this.writingInterval=setInterval((()=>{l+=1;const a=s.substr(0,Math.floor(o*l));a===s?(clearInterval(this.writingInterval),this.updateEditLine(e,!0,t),r&&i.submit(),this.skipHandler=!1,setTimeout((()=>i.focus()),0),n(!0)):h.str!==a&&(h.str=a,this.updateEditLine(h,!1,t))}),1)}))}return this.updateEditLine(e,!0),r&&i.submit(),this.skipHandler=!1,setTimeout((()=>i.focus()),0),!0},this.characterUpdater=()=>{const{vl:e,itemSize:t}=this,i=_(this.getRef("root"),!0);var s,n;n=i,((s=t).width!==n.width||s.height!==n.height)&&(this.heightCache=[],this.itemSize=i,e.updateViewport())},this.itemGetter=(e,t)=>{const{lines:i,vl:s,params:{delimiter:n,label:r}}=this,{container:a,ref:o,append:l}=t||{},h=a||(s?s.getVirtualItemsContainer():void 0);return h?new $(h,{ref:o,append:l,delimiter:n,label:r,editable:!1,value:i[e],className:"Term__line"}):null},this.heightGetter=e=>{const{heightCache:t,itemSize:s,lines:n,params:{delimiter:r,label:a,size:o,scrollbarSize:l}}=this;return i(t[e])&&(t[e]=$.getHeight({itemSize:s,delimiter:r,label:a,value:n[e],width:o.width-l})),t[e]},this.observeHandler=e=>{const{params:{size:t},vl:i}=this,{width:s,height:n}=h(e,"[0].contentRect");t.width!==s?(t.width=s,t.height=n,this.heightCache=[],i.updateViewport(),this.updateTermInfo()):t.height!==n&&(t.width=s,t.height=n,i.updateViewport(),this.updateTermInfo())},this.clickHandler=e=>{e.target===this.vl.getRef("root")&&this.lastLineFocus()},this.submitHandler=e=>{const{value:t,formattedValue:i,lockString:n}=e,{vl:r,editLine:a,listeners:o,skipHandler:l,history:{list:h}}=this,d=t.substring(n.length);!d||s(h)===d||(null==a?void 0:a.secret)||l||h.push(d),a&&(a.visible=!1,this.lines.push(i),this.clearHistoryState(),this.history.list=h,r.length=this.lines.length,r.scrollBottom(),a.clear(),a.secret=!1,this.updateTermInfo(),this.submitTimeout=setTimeout((()=>{if(a.visible=!0,a.focus(),o.submit&&!l){const e=new j(t,d||void 0);o.submit.forEach((t=>t.handler(e)))}}),1))},this.changeHandler=e=>{const{history:{list:t,index:i},vl:s}=this;t[i]!==e&&(this.history.stopHistory=!0),e||(this.history.stopHistory=!1),s.scrollBottom()},this.updateCaretPositionHandler=(e,t)=>{const{listeners:i}=this;if(this.updateTermInfo(),i.caretPosition){const s=new J(e,t);i.caretPosition.forEach((e=>e.handler(s)))}},this.lineKeydownHandler=e=>{const t=Number(m(e));38===t?this.prevHistory(e):40===t&&this.nextHistory(e)},this.prevHistory=e=>{const{index:t,list:i}=this.history;this.applyHistory(e,t<0?i.length-1:Math.max(0,t-1))},this.nextHistory=e=>{const{index:t,list:i}=this.history;return t<0?this.applyHistory(e,-1):this.applyHistory(e,t===i.length-1?-1:t+1)},this.clearHandler=()=>{this.setLines([]),this.updateTermInfo()},this.actionHandler=e=>{const{listeners:t}=this;if(t.action){const i=new G({action:e});t.action.forEach((e=>e.handler(i)))}},this.setLines=e=>{const{vl:t}=this;this.lines=e,t.length=e.length,t.clearCache(),this.updateTermInfo()},this.updateTermInfo=()=>{this.pluginManager.updateTermInfo(this.getTermInfo())},t=Y.processParams(t);const{virtualizedTopOffset:r,virtualizedBottomOffset:a,header:o}=t;this.headerField=o||"",this.init(e,t),this.ro=new u(this.observeHandler),this.keyboardShortcutsManager=new B({onAction:this.actionHandler}),this.vl=new N(this.getRef("linesContainer"),{length:this.lines.length,itemGetter:this.itemGetter,heightGetter:this.heightGetter,topOffset:r||0,bottomOffset:a||0}),this.preStart(e,t),this.pluginManager=new U(this.getTermInfo(),this.keyboardShortcutsManager)}static processParams(e){const{editLine:t}=e;if(n(t))return e;const{secret:i,value:s}=t;if(!i)return e;let r=s;return n(s)&&(r=s.split("")),l(s)&&(r=s.reduce(((e,t)=>(e.push(...n(t)?t.split(""):t.str.split("").map((e=>Object.assign(Object.assign({},t),{str:e})))),e)),[])),Object.assign(Object.assign({},e),{editLine:Object.assign(Object.assign({},t),{value:r})})}get disabled(){return this.isDisabled}set disabled(e){const{isDisabled:t,editLine:i,keyboardShortcutsManager:s}=this;t!==e&&(this.isDisabled=e,i&&(i.disabled=e),e?s.deactivate():s.activate())}get secret(){return this.editLine.secret}set secret(e){this.editLine.secret=e}get header(){return this.headerField}set header(e){const{headerField:t}=this;if(t!==e){this.getRef("headerText").innerHTML=f(e)}this.headerField=e}get value(){var e;return(null===(e=this.editLine)||void 0===e?void 0:e.value)||""}set value(e){const{editLine:t}=this;t&&(t.value=e)}get focused(){const{editLine:e}=this;return null==e?void 0:e.focused}destroy(){var e;clearInterval(this.writingInterval),clearTimeout(this.submitTimeout),this.removeKeyDownHandler(),this.unregisterAllListeners(),null===(e=this.editLine)||void 0===e||e.destroy(),this.removeListeners(),this.pluginManager.destroy(),this.keyboardShortcutsManager.destroy(),_(this.getRef("root")),super.destroy()}setCaret(e){this.params.caret=e,this.editLine&&(this.editLine.setCaret(e),this.updateTermInfo())}setHeader(e){const t=this.getRef("header"),i=this.getRef("headerText");e?(i.innerHTML=e,null==t||t.classList.remove("Term__header--hidden")):null==t||t.classList.add("Term__header--hidden"),this.params.header="",this.updateTermInfo()}blur(){const{editLine:e}=this;e&&e.blur()}focus(){const{editLine:e}=this;e&&e.focus()}updateEditLine(e,t,s){const{editLine:n}=this;if(n){const r=i(s)?n.value:s;n.value=l(r)?[...r,e]:[r,e],n.moveCaretToEnd(),t&&(n.disabled=!1)}t&&(this.isEditing=!1)}init(e,t){const{header:i=""}=t;this.setParams(e,t),this.render({header:i,hidden:i?"":"Term__header--hidden"}),this.params.scrollbarSize=v(this.getRef("root")),this.itemSize=_(this.getRef("root"),!0),this.addListeners()}preStart(e,t){this.addEditLine(t.editLine||""),this.ro.observe(e),this.vl.scrollBottom(),this.lastLineFocus(),this.frameHandler=this.characterUpdater,this.registerFrameHandler(),this.addKeyboardShortcutsManagerListeners(),this.keyboardShortcutsManager.activate()}setParams(e,t){const{params:i}=this;this.lines=t.lines,i.size.width=e.offsetWidth,i.size.height=e.offsetHeight,i.header=t.header||i.header,i.caret=t.caret||i.caret,i.label=t.label||i.label,i.delimiter=t.delimiter||i.delimiter}addListeners(){var e;const{editLine:t}=this,i=this.getRef("root");i&&i.addEventListener("click",this.clickHandler),t&&(null===(e=t.input)||void 0===e||e.addEventListener("change",this.updateTermInfo))}removeListeners(){var e;const{editLine:t}=this,i=this.getRef("root");i&&i.removeEventListener("click",this.clickHandler),t&&(null===(e=t.input)||void 0===e||e.removeEventListener("change",this.updateTermInfo))}addEditLine(e){const{vl:t,params:{delimiter:i,label:s,caret:r}}=this,a=t.getGeneralItemsContainer();a&&(this.editLine=new $(a,{label:s,delimiter:i,caret:r,className:["Term__line","Term__editLine"].join(" "),value:l(e)||n(e)?e:e.value,editable:!0,onSubmit:this.submitHandler,onChange:this.changeHandler,onUpdateCaretPosition:this.updateCaretPositionHandler,secret:h(e,"secret")||!1}),this.clearHistoryState(),this.addKeyDownHandler())}lastLineFocus(){document.hasFocus()&&this.editLine&&this.editLine.focus()}clearHistoryState(){this.history={list:[],index:-1,stopHistory:!1}}addKeyDownHandler(){const{editLine:e}=this;e&&e.input&&e.input.addEventListener("keydown",this.lineKeydownHandler)}removeKeyDownHandler(){const{editLine:e}=this;e&&e.input&&e.input.removeEventListener("keydown",this.lineKeydownHandler)}applyHistory(e,t){const{history:{index:i,list:s,stopHistory:n},editLine:r}=this;return s.length&&r&&!n?i===t?e.stopPropagation():(this.history.index=t,r.value=t>=0&&s[t]||"",r.moveCaretToEnd(),e.preventDefault()):null}addKeyboardShortcutsManagerListeners(){const{keyboardShortcutsManager:e}=this;Q?e.addShortcut("clear",{code:75,meta:!0}):e.addShortcut("clear",{code:75,ctrl:!0}),e.addListener("clear",this.clearHandler)}registerListener(e,t,i){var s;const{editLine:n}=this;n&&q.includes(e)&&(null===(s=n.input)||void 0===s||s.addEventListener(e,t,i))}unregisterAllListeners(){const{listeners:e}=this;Object.keys(e).forEach((t=>{q.includes(t)&&e[t].forEach((e=>{this.unregisterListener(t,e.handler,e.options)}))}))}unregisterListener(e,t,i){var s;const{editLine:n}=this;n&&q.includes(e)&&(null===(s=n.input)||void 0===s||s.removeEventListener(e,t,i))}getTermInfo(){const{params:{header:e}}=this;return{title:e,elements:this.getTermInfoElements(),label:this.getTermInfoLabel(),caret:this.getTermInfoCaret(),edit:this.getTermInfoEdit(),lines:this.getTermInfoLines(),history:this.history.list,addEventListener:this.addEventListener,removeEventListener:this.removeEventListener,write:this.write,secret:e=>this.secret=e}}getTermInfoElements(){const{editLine:e}=this;return{root:this.getRef("content"),edit:null==e?void 0:e.getRef("content"),title:this.getRef("header")}}getTermInfoLabel(){const{label:e,delimiter:t}=this.params;return{label:e,delimiter:t,set:this.setLabel}}getTermInfoCaret(){var e;const{editLine:t,itemSize:i}=this;return{position:(null===(e=null==t?void 0:t.input)||void 0===e?void 0:e.caretPosition)||0,offset:(null==t?void 0:t.caretOffset)||{left:0,top:0},size:{width:i.width,height:i.height},setCaretPosition:e=>{e<0?(null==t||t.moveCaretToEnd(),this.updateTermInfo()):t&&t.input&&e>=0&&(t.input.caretPosition=e,this.updateTermInfo())}}}getTermInfoEdit(){const{editLine:e}=this;return{value:z.getValueString((null==e?void 0:e.value)||""),parameterizedValue:(null==e?void 0:e.value)||"",write:this.write,focus:()=>null==e?void 0:e.focus(),blur:()=>null==e?void 0:e.blur(),update:t=>{e&&(c(t)&&!l(t)?(e.secret=Boolean(t.secret),e.value=t.value):e.value=t,this.updateTermInfo())},endOffset:(null==e?void 0:e.endOffset)||{left:0,top:0}}}getTermInfoLines(){const{lines:e}=this;return{list:e.map((e=>z.getValueString(e))),parameterizedList:e,update:this.setLines}}}export{B as KeyboardShortcutsManager,X as Plugin,V as TemplateEngine,Y as default};
