import{TemplateEngine as t,Plugin as e}from"@neuint/term-js";import i,{CLOSE_ACTION as s}from"@neuint/context-menu-plugin";const n=t=>{let{size:e}=n;if(e)return e;const i=t||document.body,s=document.createElement("div"),o=document.createElement("div");return s.style.width="100px",s.style.height="100px",s.style.overflow="scroll",o.style.height="100px",i.appendChild(s),s.appendChild(o),e=s.offsetWidth-o.offsetWidth,i.removeChild(s),n.size=e,e};class o extends t{constructor(t,e){super('<li ref="root" class="Item {active}">\n  <span class="Item__matchText">{match}</span><span class="Item__text">{suggestion}</span>\n</li>\n',t),this.isActive=!1,this.isRendered=!1,this.clickHandler=()=>{const{text:t,onClick:e}=this;e&&e(t,this)},this.hoverHandler=()=>{const{text:t,onHover:e}=this;e&&e(t,this)};const{value:i,text:s,index:n,onHover:o,onClick:h}=e;this.text=s,this.index=n,this.match=i,this.onHover=o,this.onClick=h,this.suggestion=s.replace(i,"")}get active(){return this.isActive}set active(t){const e=this.getRef("root");t!==this.isActive&&e&&(t?e.classList.add("Item__active"):e.classList.remove("Item__active")),this.isActive=t}render(){const{match:t,suggestion:e,isActive:i,isRendered:s}=this;this.removeListeners(),super.render({match:t,suggestion:e,active:i?"Item__active":""},s?{replace:this}:{}),this.addListeners(),this.isRendered=!0}destroy(){this.removeListeners(),super.destroy()}addListeners(){const t=this.getRef("root");t&&(t.addEventListener("click",this.clickHandler),t.addEventListener("mousemove",this.hoverHandler))}removeListeners(){const t=this.getRef("root");t&&(t.removeEventListener("click",this.clickHandler),t.removeEventListener("mousemove",this.hoverHandler))}}class h extends t{constructor(t,e){super('<ul ref="root" class="List"></ul>\n',t),this.reRender=!1,this.listItems=[],this.itemsField=[],this.valueField="",this.indexField=0,this.onItemHover=(t,e)=>{const{listItems:i}=this;i.forEach(((t,i)=>{t===e?(this.indexField=i,t.active=!0):t.active=!1}))},this.onItemClick=(t,e)=>{const{onSelect:i}=this;i&&i(t,e.index)},this.onSelect=e,this.render()}get items(){return this.itemsField}set items(t){this.itemsField=t,this.destroyItems(),this.render()}get value(){return this.valueField}set value(t){this.valueField!==t&&(this.valueField=t,this.destroyItems(),this.render())}get index(){return this.indexField}set index(t){const e=Math.max(0,t);this.indexField!==e&&(this.indexField=e,this.render())}render(){super.render({},this.reRender?{replace:this}:{}),this.renderItems(),this.reRender=!0}renderItems(){const t=this.getRef("root"),{itemsField:e,valueField:i,indexField:s}=this,n=[];let h=!1;t&&!n.length&&(e.forEach(((e,r)=>{if(!i||e.includes(i)){const d=s===r;h=h||d;const l=new o(t,{index:r,value:i,text:e,onHover:this.onItemHover,onClick:this.onItemClick});l.render(),l.active=d,n.push(l)}})),this.listItems=n,h||(this.indexField=0,n[0]&&(n[0].active=!0))),this.showIndexItem()}showIndexItem(){var t;const{index:e,listItems:i}=this,s=i[e];if(!(null===(t=null==s?void 0:s.nodeList)||void 0===t?void 0:t.length)||!(null==s?void 0:s.container))return;const o=this.getRef("root"),{bottom:h,top:r}=((t,e)=>{const i=n(e),s=t.getBoundingClientRect(),o=e.getBoundingClientRect(),h=s.left-o.left,r=s.top-o.top,d=o.width-i;return{left:h,top:r,bottom:o.height-i-r-s.height,right:d-h-s.width,width:s.width,height:s.height}})(s.nodeList[0],o);r<0?o.scrollTop+=r:h<0&&(o.scrollTop-=h)}destroyItems(){this.listItems.forEach((t=>t.destroy())),this.listItems=[]}}const r="dropdown-plugin-next",d="dropdown-plugin-down",l="dropdown-plugin-up",c="dropdown-plugin-submit";class a extends e{constructor(t){super(t),this.name="dropdown",this.isActionsLock=!1,this.itemsList=[],this.highlightField="",this.isActive=!1,this.onNext=(t,e)=>{const{isActive:i,list:s,isActionsLock:n}=this;if(i&&s&&!n){e.stopPropagation(),e.preventDefault();const t=s.index+1;s.index=t>=s.items.length?0:t}},this.onDown=(t,e)=>{const{isActive:i,list:s,isActionsLock:n}=this;i&&s&&!n&&(e.stopPropagation(),e.preventDefault(),s.index=Math.min(s.index+1,s.items.length-1))},this.onUp=(t,e)=>{const{isActive:i,list:s,isActionsLock:n}=this;i&&s&&!n&&(e.stopPropagation(),e.preventDefault(),s.index=Math.max(s.index-1,0))},this.onSubmit=(t,e)=>{const{onSelect:i,isActive:s,list:n}=this;s&&n&&(e.stopPropagation(),e.preventDefault(),i&&i(n.items[n.index],n.index)),this.clear()},this.selectHandler=(t,e)=>{const{onSelect:i}=this;this.hide(),i&&i(t,e)},this.hideContextMenuHandler=()=>{const{isActive:t}=this;t&&this.clear()},this.container=document.createElement("div")}get items(){return this.itemsList}set items(t){const{itemsList:e,append:i,container:s}=this;(e.length!==t.length||e.some(((e,i)=>e!==t[i])))&&(this.itemsList=t,this.renderList({append:i,className:s.className}))}get highlight(){return this.highlightField}set highlight(t){const{append:e,container:i}=this;t!==this.highlightField&&(this.highlightField=t,this.renderList({append:e,className:i.className}))}setTermInfo(t,e){super.setTermInfo(t,e),this.registerShortcut(),this.setContextMenuPlugin()}updateTermInfo(t){super.updateTermInfo(t)}clear(){this.hideList(),delete this.onSelect,delete this.onClose}destroy(){this.clear(),this.unregisterShortcut(),super.destroy()}show(t=[],e={}){t&&(this.itemsList=t);const{itemsList:i}=this,{onSelect:s,onClose:n}=e;i.length?(this.onSelect=s,this.onClose=n,this.isActive=!0,this.renderList(e)):(this.clear(),n&&n())}hide(){this.clear()}unregisterShortcut(){const{keyboardShortcutsManager:t}=this;t&&(t.removeShortcut(r),t.removeShortcut(d),t.removeShortcut(l),t.removeShortcut(c))}registerShortcut(){const{keyboardShortcutsManager:t}=this;t&&(t.addShortcut(r,{code:9}),t.addShortcut(d,{code:40}),t.addShortcut(l,{code:38}),t.addShortcut(c,{code:13}),t.addListener(r,this.onNext),t.addListener(d,this.onDown),t.addListener(l,this.onUp),t.addListener(c,this.onSubmit))}setContextMenuPlugin(){const{termInfo:t}=this;if(!t)return;const e=this.pluginManager.getPlugin(i);e?this.contextMenuPlugin=e:(this.contextMenuPlugin=new i(this.pluginManager),this.pluginManager.register(this.contextMenuPlugin))}renderList(t){const{contextMenuPlugin:e,container:i,itemsList:n,keyboardShortcutsManager:o,unlockCallback:a,highlightField:u}=this,{className:m="",append:p}=t;if(!e||!o)return;i.className=m,this.list||(this.list=new h(i,this.selectHandler)),this.renderAppend(p),a||(this.unlockCallback=o.lock([r,d,l,c,s]));const g=this.list;g.items=n,g.value=u.trim(),this.isActive=!1,e.show(i,{escHide:!0,aroundClickHide:!0,onHide:this.hideContextMenuHandler}),this.isActive=!0}renderAppend(t){const{container:e}=this;if(this.clearAppend(),t)if("string"==typeof t){const i=document.createElement("div");i.innerHTML=t.replace(/^[\n\t\s]+/,"");const s=i.firstChild;if(!s)return;e.appendChild(s),this.append=s}else e.appendChild(t),this.append=t}clearAppend(){const{container:t,append:e}=this;e&&t.removeChild(e),delete this.append}hideList(){const{list:t,unlockCallback:e,contextMenuPlugin:i,onClose:s}=this;this.clearAppend(),this.isActive=!1,e&&(e(),delete this.unlockCallback),t&&(t.destroy(),delete this.list),null==i||i.hide(),s&&s()}}export{a as default};
