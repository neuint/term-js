import{v1 as t}from"uuid";import{Plugin as s}from"@neuint/term-js";import i from"@neuint/dropdown-plugin";const e="autocomplete-plugin-show",o=t=>{const{edit:{parameterizedValue:s}}=t;return(t=>{if("string"==typeof t)return t;let s="";return t.forEach((t=>"string"==typeof t?s=`${s}${t}`:t.lock?s="":`${s}${t.str}`)),s})(s.value?s.value:s)};class n extends s{constructor(){super(...arguments),this.name="autocomplete-plugin",this.listsInfo=[],this.activeSuggestions=[],this.commandList=[],this.active="",this.isSetShowHandler=!1,this.onAutocomplete=(t,s,i)=>{const e=null==i?void 0:i.shortcut;this.showAutocomplete(e),s.stopPropagation(),s.preventDefault()},this.onSelect=t=>{const{termInfo:s}=this;if(s){const{edit:i}=s;i.focus(),i.write(t.replace(o(s),""))}this.clear()},this.onClose=()=>{this.activeSuggestions=[],this.active=""}}addList(s,i,e){const o={icon:e,items:s,actionShortcut:i,isRegistered:!1,uuid:t(),emptyOpen:!1};return this.hideSuggestionsList(),this.listsInfo.push(o),this.registerShortcut(o),()=>this.removeList(o.uuid)}showList(s,i,e){const o={icon:e,items:s,actionShortcut:i,isRegistered:!1,uuid:t(),emptyOpen:!0};return this.hideSuggestionsList(),this.listsInfo.push(o),this.registerShortcut(o),setTimeout((()=>this.showAutocomplete(o.uuid)),0),()=>this.removeList(o.uuid)}removeList(t){const{listsInfo:s,keyboardShortcutsManager:i}=this,o=s.findIndex((s=>s.uuid===t));if(o<0)return;const n=s[o];s.splice(o,1),i&&i.removeShortcut(e,n.actionShortcut)}setTermInfo(t,s){super.setTermInfo(t,s),this.registerShortcut(),this.setDropdownPlugin()}updateTermInfo(t){var s;const{termInfo:i,active:e}=this,n=o(i),r=o(t),u=null===(s=this.listsInfo.find((t=>t.uuid===e)))||void 0===s?void 0:s.emptyOpen;super.updateTermInfo(t),e&&(r||!r&&u)&&n!==r?(this.setSuggestions(),this.showSuggestions()):e&&this.clear()}clear(){this.hideSuggestionsList(),this.active=""}destroy(){var t;this.unregisterShortcut(),null===(t=this.dropdownPlugin)||void 0===t||t.hide(),super.destroy()}unregisterShortcut(){const{keyboardShortcutsManager:t}=this;t&&t.removeShortcut(e)}registerShortcut(t){const{keyboardShortcutsManager:s,listsInfo:i,isSetShowHandler:o}=this;!s||t&&t.isRegistered||(t?(s.addShortcut(e,t.actionShortcut,t.uuid),t.isRegistered=!0):i.forEach((t=>this.registerShortcut(t))),o||(s.addListener(e,this.onAutocomplete),this.isSetShowHandler=!0))}setDropdownPlugin(){const{termInfo:t}=this;if(!t)return;const s=this.pluginManager.getPlugin(i);s?this.dropdownPlugin=s:(this.dropdownPlugin=new i(this.pluginManager),this.pluginManager.register(this.dropdownPlugin))}showAutocomplete(t){var s;const{dropdownPlugin:i,listsInfo:e,active:o}=this;return!(!t||o&&o!==t)&&(this.commandList=(null===(s=e.find((s=>s.uuid===t)))||void 0===s?void 0:s.items)||[],!(!i||!this.setSuggestions())&&(this.active=t,i.isActionsLock=!0,this.showSuggestions(),setTimeout((()=>i.isActionsLock=!1),0),!0))}setSuggestions(){const{termInfo:t,commandList:s}=this;if(!t)return this.setNewSuggestions([]);const{caret:{position:i},edit:{value:e}}=t,n=o(t);return this.setNewSuggestions(i!==e.length?[]:s.filter((t=>0===t.indexOf(n)&&t!==n)))}setNewSuggestions(t){const{activeSuggestions:s}=this;return this.activeSuggestions=t,s.length!==t.length||t.some(((t,i)=>t!==s[i]))}showSuggestions(){const{activeSuggestions:t}=this;t.length?this.renderSuggestionsList():this.clear()}renderSuggestionsList(){const{dropdownPlugin:t,activeSuggestions:s,termInfo:i,active:e,listsInfo:n}=this,r=o(i),{icon:u,emptyOpen:h}=n.find((t=>t.uuid===e))||{};t&&(r||h)&&(t.show(s,{onSelect:this.onSelect,onClose:this.onClose,append:u,className:u?"Autocomplete__withIcon":""}),t.highlight=r.trim())}hideSuggestionsList(){const{dropdownPlugin:t}=this;t&&t.hide(),this.activeSuggestions=[]}}export{n as default};
