import{TemplateEngine as t,Plugin as e}from"@neuint/term-js";import{v1 as o}from"uuid";import{isArray as n,last as i,noop as s}from"lodash-es";const l=t=>{let{size:e}=l;if(e)return e;const o=t||document.body,n=document.createElement("div"),i=document.createElement("div");return n.style.width="100px",n.style.height="100px",n.style.overflow="scroll",i.style.height="100px",o.appendChild(n),n.appendChild(i),e=n.offsetWidth-i.offsetWidth,o.removeChild(n),l.size=e,e},a="terminal-center",d="edit-center",r="submit",c="submit",h="modals-plugin-hide-action";class u extends t{constructor(t,e){super('<div ref="root" class="ModalView">\n  <div ref="modal" class="ModalView__container {className}">\n    <If condition="{title}">\n      <div class="ModalView__header">\n        <If condition="{title}">\n          <div class="ModalView__title">\n            <span class="ModalView__titleText">{title}</span>\n          </div>\n        </If>\n      </div>\n    </If>\n    <div ref="modalInner" class="ModalView__modal {className}">\n      <div ref="content" class="ModalView__content">\n        <If condition="{content}">\n          <span class="ModalView__contentText">{content}</span>\n        </If>\n      </div>\n      <If condition="{closeButton}">\n        <button type="button" ref="closeButton" class="ModalView__closeButton">\n          <div class="ModalView__closeIconContainer">\n            <svg class="ModalView__closeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="none">\n              <path stroke="none" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n            </svg>\n          </div>\n        </button>\n      </If>\n    </div>\n    <If condition="{actions}">\n      <div ref="actions" class="ModalView__actions"></div>\n    </If>\n  </div>\n</div>\n',t),this.isRendered=!1,this.onActionClick=t=>{var e;const{normalizedActions:o}=this,n=t.target,i=n.getAttribute("modals-plugin-data-line"),s=n.getAttribute("modals-plugin-data-index");if(i&&s){const n=null===(e=o[Number(i)][Number(s)])||void 0===e?void 0:e.onClick;n&&n(t)}},this.onOverlayClick=t=>{const{onClose:e}=this.options;u.stopPropagation(t),e&&e()},this.options=e,this.render()}get normalizedActions(){const{actions:t=[]}=this.options;return t.length?n(t[0])?t:[t]:[]}render(){if(this.isRendered)return;const{title:t,closeButton:e,content:o,actions:n=[],className:i="",isAbsolute:s=!1}=this.options;if(super.render({className:i,title:t,closeButton:e,actions:Boolean(n.length),content:"string"==typeof o?o:""}),s){this.getModalView().classList.add("ModalView__absoluteModal")}this.renderActions(),this.addEventListeners(),this.isRendered=!0}destroy(){this.removeEventListeners(),super.destroy()}getModalView(){return this.getRef("modal")}renderActions(){const{normalizedActions:t}=this,e=this.getRef("actions");t.forEach(((t,o)=>{const n=document.createElement("div");n.className="ModalView__actionLine",t.forEach(((t,e)=>{const i=document.createElement("button");i.className=["ModalView__actionButton","submit"===t.type?"ModalView__submitActionButton":"ModalView__generalActionButton"].join(" "),i.innerHTML=t.text,i.setAttribute("modals-plugin-data-line",String(o)),i.setAttribute("modals-plugin-data-index",String(e)),n.appendChild(i)})),e.appendChild(n)}))}addEventListeners(){const{normalizedActions:t}=this,{overlayHide:e,closeButton:o}=this.options;e&&this.addOverlayEventListeners(),o&&this.addCloseButtonListener(),t.length&&this.addActionsListeners()}addOverlayEventListeners(){const t=this.getRef("modal"),e=this.getRef("root");t.addEventListener("click",u.stopPropagation),e.addEventListener("click",this.onOverlayClick)}addCloseButtonListener(){const{onClose:t}=this.options;if(t){this.getRef("closeButton").addEventListener("click",t)}}addActionsListeners(){this.getRef("actions").addEventListener("click",this.onActionClick)}removeEventListeners(){const{normalizedActions:t}=this,{overlayHide:e,closeButton:o}=this.options;e&&this.removeOverlayEventListeners(),o&&this.removeCloseButtonListener(),t.length&&this.removeActionsListeners()}removeOverlayEventListeners(){const{onClose:t}=this.options;if(t){const e=this.getRef("modal"),o=this.getRef("root");e.removeEventListener("click",u.stopPropagation),o.removeEventListener("click",t)}}removeCloseButtonListener(){const{onClose:t}=this.options;if(t){this.getRef("closeButton").removeEventListener("click",t)}}removeActionsListeners(){this.getRef("actions").removeEventListener("click",this.onActionClick)}}u.stopPropagation=t=>{null==t||t.stopPropagation()};class m extends e{constructor(){super(...arguments),this.name="modals-plugin",this.modalStack=[],this.hideLast=()=>{const{modalStack:t}=this,e=i(t);e&&e.options.escHide&&(this.hide(e.uuid),e.options.onClose&&e.options.onClose())}}setTermInfo(t,e){super.setTermInfo(t,e),e.addShortcut(h,{code:27}),e.addListener(h,this.hideLast)}updateTermInfo(t){super.updateTermInfo(t)}clear(){const{modalStack:t}=this;t.forEach((({uuid:t})=>this.hide(t)))}destroy(){this.clear(),super.destroy()}show(t){const{termInfo:e,unlockCallback:n,keyboardShortcutsManager:i}=this;if(!e||!e.elements.root)return s;const l=e.elements.root.parentElement,{content:a,onClose:d,title:r,overlayHide:c,closeButton:m,actions:p,className:v,position:f}=t;e.edit.blur();const g=o(),w=()=>{this.hide(g),d&&d()},_="edit-center"===f,k=new u(l,{onClose:w,content:a,title:r,overlayHide:c,closeButton:m,actions:p,className:v,isAbsolute:_});return _&&this.updatePosition(k,f),this.modalStack.push({uuid:g,options:t,view:k}),!n&&i&&(this.unlockCallback=i.lock([h])),w}hide(t){const{termInfo:e,unlockCallback:o}=this,{modalStack:n}=this,i=n.findIndex((e=>e.uuid===t));i>=0&&(n[i].view.destroy(),n.splice(i,1)),n.length||(o&&o(),delete this.unlockCallback,null==e||e.edit.focus())}updatePosition(t,e){const{termInfo:o}=this,n=t.getModalView();if(!n||!o||"edit-center"!==e)return;const{edit:i,root:s}=o.elements;if(!i||!s)return;const{top:a,bottom:d}=((t,e)=>{const o=l(e),n=t.getBoundingClientRect(),i=e.getBoundingClientRect(),s=n.left-i.left,a=n.top-i.top,d=i.width-o;return{left:s,top:a,bottom:i.height-o-a-n.height,right:d-s-n.width,width:n.width,height:n.height}})(i,s);a<=d?n.style.top=`${Math.max(0,a)}px`:d>=-1*i.offsetHeight?n.style.bottom=`${Math.max(0,d)}px`:(n.style.top="50%",n.style.transform="translate(-50%, -50%)")}}export{d as EDIT_CENTER_POSITION,c as GENERAL_BUTTON_TYPE,r as PRIMARY_BUTTON_TYPE,a as TERMINAL_CENTER_POSITION,m as default};
