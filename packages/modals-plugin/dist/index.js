import{TemplateEngine as t,Plugin as e}from"@neuint/term-js";import{v1 as o}from"uuid";import{isArray as n,last as s,noop as i}from"lodash-es";const l="terminal-center",a="edit-center",d="submit",r="submit",c="modals-plugin-hide-action";class h extends t{constructor(t,e){super('<div ref="root" class="ModalView">\n  <div ref="modal" class="ModalView__modal {className}">\n    <If condition="{title || closeButton}">\n      <div class="ModalView__header">\n        <If condition="{title}">\n          <div class="ModalView__title">\n            <span class="ModalView__titleText">{title}</span>\n          </div>\n        </If>\n        <If condition="{closeButton}">\n          <button type="button" ref="closeButton" class="ModalView__closeButton">\n            <svg class="ModalView__closeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="none">\n              <path stroke="none" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n            </svg>\n          </button>\n        </If>\n      </div>\n    </If>\n    <div ref="content" class="ModalView__content">\n      <If condition="{content}">\n        <span class="ModalView__contentText">{content}</span>\n      </If>\n    </div>\n    <If condition="{actions}">\n      <div ref="actions" class="ModalView__actions"></div>\n    </If>\n  </div>\n</div>\n',t),this.isRendered=!1,this.onActionClick=t=>{var e;const{normalizedActions:o}=this,n=t.target,s=n.getAttribute("modals-plugin-data-line"),i=n.getAttribute("modals-plugin-data-index");if(s&&i){const n=null===(e=o[Number(s)][Number(i)])||void 0===e?void 0:e.onClick;n&&n(t)}},this.onOverlayClick=t=>{const{onClose:e}=this.options;h.stopPropagation(t),e&&e()},this.options=e,this.render()}get normalizedActions(){const{actions:t=[]}=this.options;return t.length?n(t[0])?t:[t]:[]}render(){if(this.isRendered)return;const{title:t,closeButton:e,content:o,actions:n=[],className:s="",isAbsolute:i=!1}=this.options;if(super.render({className:s,title:t,closeButton:e,actions:Boolean(n.length),content:"string"==typeof o?o:""}),i){this.getModalView().classList.add("ModalView__absoluteModal")}this.renderActions(),this.addEventListeners(),this.isRendered=!0}destroy(){this.removeEventListeners(),super.destroy()}getModalView(){return this.getRef("modal")}renderActions(){const{normalizedActions:t}=this,e=this.getRef("actions");t.forEach(((t,o)=>{const n=document.createElement("div");n.className="ModalView__actionLine",t.forEach(((t,e)=>{const s=document.createElement("button");s.className=["ModalView__actionButton","submit"===t.type?"ModalView__submitActionButton":"ModalView__generalActionButton"].join(" "),s.innerHTML=t.text,s.setAttribute("modals-plugin-data-line",String(o)),s.setAttribute("modals-plugin-data-index",String(e)),n.appendChild(s)})),e.appendChild(n)}))}addEventListeners(){const{normalizedActions:t}=this,{overlayHide:e,closeButton:o}=this.options;e&&this.addOverlayEventListeners(),o&&this.addCloseButtonListener(),t.length&&this.addActionsListeners()}addOverlayEventListeners(){const t=this.getRef("modal"),e=this.getRef("root");t.addEventListener("click",h.stopPropagation),e.addEventListener("click",this.onOverlayClick)}addCloseButtonListener(){const{onClose:t}=this.options;if(t){this.getRef("closeButton").addEventListener("click",t)}}addActionsListeners(){this.getRef("actions").addEventListener("click",this.onActionClick)}removeEventListeners(){const{normalizedActions:t}=this,{overlayHide:e,closeButton:o}=this.options;e&&this.removeOverlayEventListeners(),o&&this.removeCloseButtonListener(),t.length&&this.removeActionsListeners()}removeOverlayEventListeners(){const{onClose:t}=this.options;if(t){const e=this.getRef("modal"),o=this.getRef("root");e.removeEventListener("click",h.stopPropagation),o.removeEventListener("click",t)}}removeCloseButtonListener(){const{onClose:t}=this.options;if(t){this.getRef("closeButton").removeEventListener("click",t)}}removeActionsListeners(){this.getRef("actions").removeEventListener("click",this.onActionClick)}}h.stopPropagation=t=>{null==t||t.stopPropagation()};const u=t=>{let{size:e}=u;if(e)return e;const o=t||document.body,n=document.createElement("div"),s=document.createElement("div");return n.style.width="100px",n.style.height="100px",n.style.overflow="scroll",s.style.height="100px",o.appendChild(n),n.appendChild(s),e=n.offsetWidth-s.offsetWidth,o.removeChild(n),u.size=e,e};class m extends e{constructor(){super(...arguments),this.name="modals-plugin",this.modalStack=[],this.hideLast=()=>{const{modalStack:t}=this,e=s(t);e&&e.options.escHide&&(this.hide(e.uuid),e.options.onClose&&e.options.onClose())}}setTermInfo(t,e){super.setTermInfo(t,e),e.addShortcut(c,{code:27}),e.addListener(c,this.hideLast)}updateTermInfo(t){super.updateTermInfo(t)}clear(){const{modalStack:t}=this;t.forEach((({uuid:t})=>this.hide(t)))}destroy(){this.clear(),super.destroy()}show(t){const{termInfo:e,unlockCallback:n,keyboardShortcutsManager:s}=this;if(!e||!e.elements.root)return i;const{root:l}=e.elements,{content:a,onClose:d,title:r,overlayHide:u,closeButton:m,actions:p,className:v,position:f}=t;e.edit.blur();const g=o(),w=()=>{this.hide(g),d&&d()},k="edit-center"===f,L=new h(l,{onClose:w,content:a,title:r,overlayHide:u,closeButton:m,actions:p,className:v,isAbsolute:k});return k&&this.updatePosition(L,f),this.modalStack.push({uuid:g,options:t,view:L}),!n&&s&&(this.unlockCallback=s.lock([c])),w}hide(t){const{termInfo:e,unlockCallback:o}=this,{modalStack:n}=this,s=n.findIndex((e=>e.uuid===t));s>=0&&(n[s].view.destroy(),n.splice(s,1)),n.length||(o&&o(),delete this.unlockCallback,null==e||e.edit.focus())}updatePosition(t,e){const{termInfo:o}=this,n=t.getModalView();if(!n||!o||"edit-center"!==e)return;const{edit:s,root:i}=o.elements;if(!s||!i)return;const{top:l,bottom:a}=((t,e)=>{const o=u(e),n=t.getBoundingClientRect(),s=e.getBoundingClientRect(),i=n.left-s.left,l=n.top-s.top,a=s.width-o;return{left:i,top:l,bottom:s.height-o-l-n.height,right:a-i-n.width,width:n.width,height:n.height}})(s,i);l<=a?n.style.top=`${Math.max(0,l)}px`:a>=-1*s.offsetHeight?n.style.bottom=`${Math.max(0,a)}px`:(n.style.top="50%",n.style.transform="translate(-50%, -50%)")}}export{a as EDIT_CENTER_POSITION,r as GENERAL_BUTTON_TYPE,d as PRIMARY_BUTTON_TYPE,l as TERMINAL_CENTER_POSITION,m as default};
