import{Plugin as t}from"@neuint/term-js";import{isArray as s,noop as i,get as e}from"lodash-es";const r=t=>{if("string"==typeof t)return{value:{str:t}};if(void 0!==(null==t?void 0:t.str))return{value:t};if(void 0!==(null==t?void 0:t.value)){const{value:s,withSubmit:i}=t;return{withSubmit:i,value:"string"==typeof s?{str:s}:s}}},n=(t,i)=>{const e=(t=>{if(void 0===(null==t?void 0:t.data))return[r(t)];const{duration:i,data:e}=t,n=s(e)?e.map(r):[r(e)],o=i?n.reduce(((t,s)=>t+s.value.str.length),0):0,h=i&&o?i/o:0;return n.map((t=>Object.assign(Object.assign({},t),{duration:i?t.value.str.length*h:void 0})))})(i);return new Promise((s=>{const i=()=>{const r=e.shift();if(!r)return void s(void 0);const n=t.write(r.value,{duration:r.duration,withSubmit:r.withSubmit});n instanceof Promise?n.then(i):i()};i()}))};class o extends t{constructor(){super(...arguments),this.flowsField={},this.step=0,this.branchData={},this.isWaiting=!1,this.clear=i,this.onKeyboardShortcut=()=>{var t,s;const{branch:i,step:e}=this;i&&(null===(s=null===(t=i[e])||void 0===t?void 0:t.onExit)||void 0===s||s.call(t,this.branchData),this.branch=void 0,this.step=0,this.branchData={}),this.termInfo.edit.write("",{withSubmit:!0})},this.onSubmit=t=>{let{branch:s,flows:i,branchData:e,isWaiting:r}=this;if(r)return;let n=t.typedValue||"";if(s){const{handler:t=(()=>Promise.resolve()),variableName:i}=s[this.step];i&&(e[i]=n);const r=t(e);return r&&(this.isWaiting=!0),void(r||Promise.resolve(void 0)).then(this.onStepResult)}n=n.trim(),s=i[n],s&&(this.step=0,this.branch=s,this.branchData={},this.showStep())},this.onStepResult=t=>{const{to:s,write:i}=t||{};if(s){const[t,i]=s.split("|");this.step=parseInt(t,10),this.branch=i?this.flows[i]:this.branch}else this.step+=1;const e=i?n(this.termInfo,i):void 0;(e instanceof Promise?e:Promise.resolve(!0)).then((()=>{this.showStep()}))},this.showStep=()=>{const{branch:t,step:s}=this;if(this.isWaiting=!1,t.length-1<s)return this.branch=void 0,this.step=0,void(this.branchData={});const{write:i,onEnter:e,onWrite:r,secret:o=!1}=t[s],h=i&&"function"==typeof i?i(this.branchData):i,a=h?n(this.termInfo,h):void 0;if((a instanceof Promise?a:Promise.resolve(!0)).then((()=>{this.termInfo.secret(o),r&&r(this.branchData)})),!e)return;e(this.branchData)&&(n(this.termInfo,h),this.branch=void 0,this.step=0,this.branchData={})}}get flows(){return this.flowsField}set flows(t){this.flowsField=t,this.runAutoStartBranch()}setTermInfo(t,s){super.setTermInfo(t,s),this.termInfo.addEventListener("submit",this.onSubmit),this.runAutoStartBranch(),s.addShortcut("flows",{code:67,ctrl:!0}),s.addListener("flows",this.onKeyboardShortcut)}runAutoStartBranch(){const{flows:t,termInfo:s,branch:i}=this;if(!s||i)return;const r=Object.keys(t).find((s=>e(t[s],"0.autostart")));r&&(this.step=0,this.branch=t[r],this.branchData={},this.showStep())}}export{o as default};
