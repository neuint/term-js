import e,{useRef as t,useState as r,useEffect as n,Children as i}from"react";import{isArray as a,noop as u}from"lodash-es";import o from"@neuint/term-js";const l=e=>{if("string"==typeof e)return{value:{str:e}};if(void 0!==(null==e?void 0:e.str))return{value:e};if(void 0!==(null==e?void 0:e.value)){const{value:t,withSubmit:r}=e;return{withSubmit:r,value:"string"==typeof t?{str:t}:t}}},s=(e,t)=>{const r=(e=>{if(void 0===(null==e?void 0:e.data))return[l(e)];const{duration:t,data:r}=e,n=a(r)?r.map(l):[l(r)],i=t?n.reduce(((e,t)=>e+t.value.str.length),0):0,u=t&&i?t/i:0;return n.map((e=>Object.assign(Object.assign({},e),{duration:t?e.value.str.length*u:void 0})))})(t);return new Promise((t=>{const n=()=>{const i=r.shift();if(!i)return void t(void 0);const a=e.write(i.value,{duration:i.duration,withSubmit:i.withSubmit});a instanceof Promise?a.then(n):n()};n()}))},d=(e,t)=>{const{prevHandler:r,handler:n,event:i}=t;r&&r!==n&&e.removeEventListener(i,r),n&&e.addEventListener(i,n)},c=a=>{const{className:l,label:c,header:v="",delimiter:m,onSubmit:h,onChange:f,initLines:b=[],secret:p=!1,initValue:g,onWritten:w=u,write:L,children:S}=a,E=t(),[O,j]=r(!1),y=t(),C=t({onSubmit:h,onChange:f}),H=t(void 0);return n((()=>{const{current:e}=y;e?(e.header=v,e.setLabel({label:c,delimiter:m}),((e,t)=>{e.secret!==t&&(e.value="",e.secret=t)})(e,p),d(e,{event:"submit",handler:h,prevHandler:C.current.onSubmit}),d(e,{event:"change",handler:f,prevHandler:C.current.onChange})):(y.current=new o(E.current,{label:c,header:v,lines:b,virtualizedTopOffset:400,virtualizedBottomOffset:400,editLine:{secret:p,value:g}}),h&&y.current.addEventListener("submit",h),f&&y.current.addEventListener("change",f),j(!0))}),[g,p,v,c,m,h,f,b]),n((()=>()=>{var e;null===(e=y.current)||void 0===e||e.destroy(),y.current=void 0}),[]),n((()=>{void 0===H.current&&void 0!==L&&(H.current=L,s(y.current,L).then((()=>{H.current=void 0,w()})))}),[w,L]),e.createElement("div",{ref:E,className:l},S&&y.current&&O?i.map(S,(t=>e.cloneElement(t,{term:y.current}))):null)};export{c as default};
