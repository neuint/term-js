import{TemplateEngine as e,Plugin as t}from"@neuint/term-js";import{isString as i}from"lodash-es";const o=e=>{let{size:t}=o;if(t)return t;const i=e||document.body,n=document.createElement("div"),s=document.createElement("div");return n.style.width="100px",n.style.height="100px",n.style.overflow="scroll",s.style.height="100px",i.appendChild(n),n.appendChild(s),t=n.offsetWidth-s.offsetWidth,i.removeChild(n),o.size=t,t},n=(e,t)=>{const i=o(t),n=e.getBoundingClientRect(),s=t.getBoundingClientRect(),r=n.left-s.left,l=n.top-s.top,d=s.width-i;return{left:r,top:l,bottom:s.height-i-l-n.height,right:d-r-n.width,width:n.width,height:n.height}},s=e=>null==e?void 0:e.stopPropagation();class r extends e{constructor(e){super('<div ref="root" class="ContextMenuView"></div>\n',e),this.reRender=!1}render(){super.render({},this.reRender?{replace:this}:{}),this.reRender=!0}}const l="context-menu-plugin-close";class d extends t{constructor(){super(...arguments),this.name="context-menu",this.isVisible=!1,this.escHide=!1,this.aroundClickHide=!1,this.escHandler=()=>{this.escHide&&this.hide()},this.rootClickHandler=()=>{this.aroundClickHide&&this.hide()},this.updatePosition=()=>{const{isVisible:e}=this;this.updateEndOfLinePosition(),e||this.setVisible()}}show(e,t={}){this.hide();const{escHide:i=!1,aroundClickHide:o=!1,onHide:n}=t;this.escHide=i,this.onHide=n,this.aroundClickHide=o,this.render(e),this.updatePosition()}hide(){const{contextMenuView:e,onHide:t}=this;if(e){const i=e.getRef("root");i&&i.removeEventListener("click",s),e.destroy(),delete this.contextMenuView,t&&t()}}setTermInfo(e,t){var i,o,n,s,r,d,h,u,c,v,a;null===(n=null===(o=null===(i=this.termInfo)||void 0===i?void 0:i.elements)||void 0===o?void 0:o.root)||void 0===n||n.removeEventListener("click",this.rootClickHandler),null===(h=null===(d=null===(r=null===(s=this.termInfo)||void 0===s?void 0:s.elements)||void 0===r?void 0:r.root)||void 0===d?void 0:d.querySelector(".VirtualizedList__root"))||void 0===h||h.removeEventListener("scroll",this.updatePosition),super.setTermInfo(e,t);const{root:f}=e.elements;null==f||f.addEventListener("click",this.rootClickHandler),null===(a=null===(v=null===(c=null===(u=this.termInfo)||void 0===u?void 0:u.elements)||void 0===c?void 0:c.root)||void 0===v?void 0:v.querySelector(".VirtualizedList__root"))||void 0===a||a.addEventListener("scroll",this.updatePosition),t.addShortcut(l,{code:27}),t.addListener(l,this.escHandler),this.updatePosition()}updateTermInfo(e){super.updateTermInfo(e),this.updatePosition()}destroy(){var e,t,i;const{keyboardShortcutsManager:o,termInfo:n}=this,s=null==n?void 0:n.elements.root;o&&(o.removeListener(this.escHandler),o.removeShortcut(l)),s&&s.removeEventListener("click",this.rootClickHandler),null===(i=null===(t=null===(e=null==n?void 0:n.elements)||void 0===e?void 0:e.root)||void 0===t?void 0:t.querySelector(".VirtualizedList__root"))||void 0===i||i.removeEventListener("scroll",this.updatePosition),super.destroy()}clear(){this.hide()}render(e){var t,o;const{termInfo:n}=this;if(!(null===(t=null==n?void 0:n.elements)||void 0===t?void 0:t.root))return;const l=new r(null===(o=null==n?void 0:n.elements)||void 0===o?void 0:o.root);l.render();const d=l.getRef("root");d&&(d.addEventListener("click",s),this.contextMenuView=l,this.isVisible=!1,i(e)?d.innerHTML=e:d.appendChild(e))}updateEndOfLinePosition(){const{termInfo:e,contextMenuView:t}=this;if(!e||!t)return;const i=t.getRef("root");if(!i)return;const{elements:{root:o,edit:s},edit:{endOffset:r}}=e;if(!s||!o)return;const l=n(s,o),d=l.top+l.height-r.top,h=l.left+r.left;i.style.left=`${h}px`,i.style.top=`${d}px`,this.normalizedPosition(h,d)}setVisible(){const{contextMenuView:e}=this;if(!e)return;const t=e.getRef("root");t&&(t.style.visibility="visible",this.isVisible=!0)}normalizedPosition(e,t){var i,o,s;const{contextMenuView:r,termInfo:l}=this,d=null===(o=null===(i=this.termInfo)||void 0===i?void 0:i.elements)||void 0===o?void 0:o.root,{width:h=0,height:u=0}=(null===(s=null==l?void 0:l.caret)||void 0===s?void 0:s.size)||{};if(!r||!d)return;const c=r.getRef("root");if(!c)return;c.style.width="",c.style.height="";const{left:v,right:a,width:f,bottom:p,top:m,height:g}=n(c,d);if(a<0&&v+h-f>a){let t=e-f+h;t<0&&(c.style.width=`${f+t}px`,t=0),c.style.left=`${t}px`}else a<0&&(c.style.width=`${f+a}px`);if(p<0&&m-u-g>p){let e=t-g-u;e<0&&(c.style.height=`${g+e}px`,e=0),c.style.top=`${e}px`}else p<0&&(c.style.height=`${g+p}px`)}}export{l as CLOSE_ACTION,d as default};
