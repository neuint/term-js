import{TemplateEngine as e,Plugin as t}from"@neuint/term-js";import{isString as i,noop as o}from"lodash-es";class n extends e{constructor(e){super('<div ref="root" class="ContextMenuView"></div>\n',e),this.reRender=!1}render(){super.render({},this.reRender?{replace:this}:{}),this.reRender=!0}}const s="end of line",r="context-menu-plugin-close",d=e=>{let{size:t}=d;if(t)return t;const i=e||document.body,o=document.createElement("div"),n=document.createElement("div");return o.style.width="100px",o.style.height="100px",o.style.overflow="scroll",n.style.height="100px",i.appendChild(o),o.appendChild(n),t=o.offsetWidth-n.offsetWidth,i.removeChild(o),d.size=t,t},l=e=>e.stopPropagation();class h extends t{constructor(){super(...arguments),this.name="context-menu",this.isVisible=!1,this.escHide=!1,this.aroundClickHide=!1,this.escHandler=()=>{this.escHide&&this.hide()},this.rootClickHandler=()=>{this.aroundClickHide&&this.hide()}}show(e,t,i={}){this.hide();const{position:o,escHide:n=!1,aroundClickHide:s=!1,onHide:r}=i;("position"!==t||o)&&(this.target=t,this.escHide=n,this.onHide=r,this.aroundClickHide=s,this.render(e),this.updatePosition())}hide(){const{contextMenuView:e,onHide:t}=this;if(e){const i=e.getRef("root");i&&i.removeEventListener("click",l),e.destroy(),delete this.contextMenuView,t&&t()}}setTermInfo(e,t){super.setTermInfo(e,t);const{root:i}=e.elements;null==i||i.addEventListener("click",this.rootClickHandler),t.addShortcut(r,{code:27}),t.addListener(r,this.escHandler),this.updatePosition()}updateTermInfo(e){super.updateTermInfo(e),this.updatePosition()}destroy(){const{keyboardShortcutsManager:e,termInfo:t}=this,i=null==t?void 0:t.elements.root;e&&(e.removeListener(this.escHandler),e.removeShortcut(r)),i&&i.removeEventListener("click",this.rootClickHandler),super.destroy()}clear(){this.hide()}render(e){var t,o;const{termInfo:s,target:r}=this,d="end of line"===r?null===(t=null==s?void 0:s.elements)||void 0===t?void 0:t.edit:null===(o=null==s?void 0:s.elements)||void 0===o?void 0:o.root;if(!d)return;const h=new n(d);h.render();const c=h.getRef("root");c&&(c.addEventListener("click",l),this.contextMenuView=h,this.isVisible=!1,i(e)?c.innerHTML=e:c.appendChild(e))}updatePosition(){const{target:e,isVisible:t}=this;({"end of line":()=>this.updateEndOfLinePosition(),position:()=>this.updateFixedPosition()}[e||""]||o)(),t||this.setVisible()}updateEndOfLinePosition(){const{termInfo:e,contextMenuView:t}=this;if(!e||!t)return;const{size:{height:i}}=e.caret,{endOffset:{left:o,top:n}}=e.edit,s=t.getRef("root");if(!s)return;const r=n+i;s.style.left=`${o}px`,s.style.top=`${r}px`,this.normalizedPosition(o,r)}updateFixedPosition(){const{position:e,contextMenuView:t}=this;if(!e||!t)return;const i=t.getRef("root");i&&(i.style.left=`${e.left}px`,i.style.top=`${e.top}px`,this.normalizedPosition(e.left,e.top))}setVisible(){const{contextMenuView:e}=this;if(!e)return;const t=e.getRef("root");t&&(t.style.visibility="visible",this.isVisible=!0)}normalizedPosition(e,t){var i,o;const{contextMenuView:n,target:s,termInfo:r}=this,l=null===(o=null===(i=this.termInfo)||void 0===i?void 0:i.elements)||void 0===o?void 0:o.root;if(!n||!l)return;const h=n.getRef("root");if(!h)return;const{right:c,bottom:u}=((e,t)=>{const i=d(t),o=e.getBoundingClientRect(),n=t.getBoundingClientRect(),s=o.left-n.left,r=o.top-n.top,l=n.width-i;return{left:s,top:r,bottom:n.height-i-r-o.height,right:l-s-o.width,width:o.width,height:o.height}})(h,l);if(c<0&&(h.style.left=`${e+c}px`),u<0){const e=t-h.offsetHeight-("end of line"===s&&(null==r?void 0:r.caret.size.height)||0);h.style.top=`${e}px`}}}export{r as CLOSE_ACTION,s as END_OF_LINE_TYPE,h as default};
