import{TemplateEngine as e,Plugin as t}from"@neuint/term-js";import{isString as i}from"lodash-es";const o=e=>{let{size:t}=o;if(t)return t;const i=e||document.body,s=document.createElement("div"),n=document.createElement("div");return s.style.width="100px",s.style.height="100px",s.style.overflow="scroll",n.style.height="100px",i.appendChild(s),s.appendChild(n),t=s.offsetWidth-n.offsetWidth,i.removeChild(s),o.size=t,t},s=(e,t)=>{const i=o(t),s=e.getBoundingClientRect(),n=t.getBoundingClientRect(),r=s.left-n.left,l=s.top-n.top,d=n.width-i;return{left:r,top:l,bottom:n.height-i-l-s.height,right:d-r-s.width,width:s.width,height:s.height}},n=e=>null==e?void 0:e.stopPropagation();class r extends e{constructor(e){super('<div ref="root" class="ContextMenuView"></div>\n',e),this.reRender=!1}render(){super.render({},this.reRender?{replace:this}:{}),this.reRender=!0}}const l="context-menu-plugin-close";class d extends t{constructor(){super(...arguments),this.name="context-menu",this.isVisible=!1,this.escHide=!1,this.aroundClickHide=!1,this.escHandler=()=>{this.escHide&&this.hide()},this.rootClickHandler=()=>{this.aroundClickHide&&this.hide()},this.updatePosition=()=>{const{isVisible:e}=this;this.updateEndOfLinePosition(),e||this.setVisible()}}show(e,t={}){this.hide();const{escHide:i=!1,aroundClickHide:o=!1,onHide:s}=t;this.escHide=i,this.onHide=s,this.aroundClickHide=o,this.render(e),this.updatePosition()}hide(){const{contextMenuView:e,onHide:t}=this;if(e){const i=e.getRef("root");i&&i.removeEventListener("click",n),e.destroy(),delete this.contextMenuView,t&&t()}}setTermInfo(e,t){var i,o,s,n,r,d,h,c,u,v,a;null===(s=null===(o=null===(i=this.termInfo)||void 0===i?void 0:i.elements)||void 0===o?void 0:o.root)||void 0===s||s.removeEventListener("click",this.rootClickHandler),null===(h=null===(d=null===(r=null===(n=this.termInfo)||void 0===n?void 0:n.elements)||void 0===r?void 0:r.root)||void 0===d?void 0:d.querySelector(".VirtualizedList__root"))||void 0===h||h.removeEventListener("scroll",this.updatePosition),super.setTermInfo(e,t);const{root:f}=e.elements;null==f||f.addEventListener("click",this.rootClickHandler),null===(a=null===(v=null===(u=null===(c=this.termInfo)||void 0===c?void 0:c.elements)||void 0===u?void 0:u.root)||void 0===v?void 0:v.querySelector(".VirtualizedList__root"))||void 0===a||a.addEventListener("scroll",this.updatePosition),t.addShortcut(l,{code:27}),t.addListener(l,this.escHandler),this.updatePosition()}updateTermInfo(e){super.updateTermInfo(e),this.updatePosition()}destroy(){const{keyboardShortcutsManager:e,termInfo:t}=this,i=null==t?void 0:t.elements.root;e&&(e.removeListener(this.escHandler),e.removeShortcut(l)),i&&i.removeEventListener("click",this.rootClickHandler),super.destroy()}clear(){this.hide()}render(e){var t,o;const{termInfo:s}=this;if(!(null===(t=null==s?void 0:s.elements)||void 0===t?void 0:t.root))return;const l=new r(null===(o=null==s?void 0:s.elements)||void 0===o?void 0:o.root);l.render();const d=l.getRef("root");d&&(d.addEventListener("click",n),this.contextMenuView=l,this.isVisible=!1,i(e)?d.innerHTML=e:d.appendChild(e))}updateEndOfLinePosition(){const{termInfo:e,contextMenuView:t}=this;if(!e||!t)return;const i=t.getRef("root");if(!i)return;const{elements:{root:o,edit:n},edit:{endOffset:r}}=e;if(!n||!o)return;const l=s(n,o),d=l.top+l.height-r.top,h=l.left+r.left;i.style.left=`${h}px`,i.style.top=`${d}px`,this.normalizedPosition(h,d)}setVisible(){const{contextMenuView:e}=this;if(!e)return;const t=e.getRef("root");t&&(t.style.visibility="visible",this.isVisible=!0)}normalizedPosition(e,t){var i,o,n;const{contextMenuView:r,termInfo:l}=this,d=null===(o=null===(i=this.termInfo)||void 0===i?void 0:i.elements)||void 0===o?void 0:o.root,{width:h=0,height:c=0}=(null===(n=null==l?void 0:l.caret)||void 0===n?void 0:n.size)||{};if(!r||!d)return;const u=r.getRef("root");if(!u)return;u.style.width="",u.style.height="";const{left:v,right:a,width:f,bottom:p,top:m,height:g}=s(u,d);if(a<0&&v+h-f>a){let t=e-f+h;t<0&&(u.style.width=`${f+t}px`,t=0),u.style.left=`${t}px`}else a<0&&(u.style.width=`${f+a}px`);if(p<0&&m-c-g>p){let e=t-g-c;e<0&&(u.style.height=`${g+e}px`,e=0),u.style.top=`${e}px`}else p<0&&(u.style.height=`${g+p}px`)}}export{l as CLOSE_ACTION,d as default};
